# Quickstart: FastAPI API Scaffold

**Feature**: 001-fastapi-api-scaffold  
**Audience**: Developers implementing the FastAPI scaffold feature  
**Prerequisites**: Riso template repository cloned, uv installed, Python 3.11+

## Overview

This quickstart guides you through implementing and validating the FastAPI API scaffold feature. Follow these steps to create the template files, test the scaffold, and validate it meets all success criteria.

## Phase 1: Create Template Structure

### Step 1: Set Up Template Directory

```bash
# From repository root
cd template/files/python

# Create FastAPI module directory
mkdir -p api_fastapi/{routes,models,middleware,tests}

# Verify structure
tree api_fastapi
```

**Expected Output**:

```text
api_fastapi/
├── routes/
├── models/
├── middleware/
└── tests/
```

### Step 2: Create Core Application Files

Create the main application entry point:

```bash
# Create main.py template
cat > api_fastapi/main.py.jinja << 'EOF'
"""
FastAPI application entry point.

Generated by Riso template.
"""
from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware

from {{ package_name }}.api.config import Settings
from {{ package_name }}.api.routes import health, examples

# Load configuration
settings = Settings()

# Create FastAPI application
app = FastAPI(
    title=settings.app_name,
    description="API generated by Riso template",
    version=settings.version,
    docs_url="/docs",
    redoc_url="/redoc",
)

# Configure CORS
app.add_middleware(
    CORSMiddleware,
    allow_origins=settings.cors_origins,
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# Register routers
app.include_router(health.router)
app.include_router(examples.router)

@app.get("/")
async def root():
    """Root endpoint."""
    return {
        "message": f"Welcome to {settings.app_name}",
        "version": settings.version,
        "docs": "/docs",
    }
EOF
```

Create configuration module:

```bash
cat > api_fastapi/config.py.jinja << 'EOF'
"""
Application configuration using Pydantic Settings.

Environment variables automatically loaded from .env file.
"""
from pydantic_settings import BaseSettings, SettingsConfigDict


class Settings(BaseSettings):
    """Application settings."""
    
    model_config = SettingsConfigDict(
        env_file=".env",
        env_file_encoding="utf-8",
        case_sensitive=False,
    )
    
    # Server configuration
    host: str = "0.0.0.0"
    port: int = 8000
    reload: bool = True
    
    # CORS configuration
    cors_origins: list[str] = ["http://localhost:3000"]
    
    # Application metadata
    app_name: str = "{{ project_name }}"
    version: str = "0.1.0"
    
    # Logging
    log_level: str = "INFO"
    environment: str = "development"
EOF
```

### Step 3: Create Route Modules

Health check routes:

```bash
cat > api_fastapi/routes/health.py.jinja << 'EOF'
"""Health check endpoints."""
from datetime import datetime

from fastapi import APIRouter

from {{ package_name }}.api.config import Settings

router = APIRouter(prefix="/health", tags=["Health"])
settings = Settings()


@router.get("/")
async def health_check():
    """Overall health status."""
    return {
        "status": "healthy",
        "version": settings.version,
        "timestamp": datetime.utcnow().isoformat() + "Z",
    }


@router.get("/ready")
async def readiness_check():
    """Readiness probe for Kubernetes."""
    return {"status": "ready"}


@router.get("/live")
async def liveness_check():
    """Liveness probe for Kubernetes."""
    return {"status": "alive"}
EOF
```

Example CRUD routes:

```bash
cat > api_fastapi/routes/examples.py.jinja << 'EOF'
"""Example CRUD endpoints demonstrating FastAPI patterns."""
from datetime import datetime
from uuid import uuid4

from fastapi import APIRouter, HTTPException

from {{ package_name }}.api.models.requests import ExampleCreateRequest, ExampleUpdateRequest
from {{ package_name }}.api.models.responses import ExampleResponse

router = APIRouter(prefix="/examples", tags=["Examples"])

# In-memory storage for demo (replace with database in real apps)
_examples: dict[str, dict] = {}


@router.get("/", response_model=list[ExampleResponse])
async def list_examples(limit: int = 10, offset: int = 0):
    """List all examples with pagination."""
    examples = list(_examples.values())
    return examples[offset : offset + limit]


@router.post("/", response_model=ExampleResponse, status_code=201)
async def create_example(request: ExampleCreateRequest):
    """Create a new example."""
    example_id = str(uuid4())
    now = datetime.utcnow().isoformat() + "Z"
    
    example = {
        "id": example_id,
        "name": request.name,
        "value": request.value,
        "description": request.description,
        "tags": request.tags or [],
        "created_at": now,
        "updated_at": now,
    }
    
    _examples[example_id] = example
    return example


@router.get("/{example_id}", response_model=ExampleResponse)
async def get_example(example_id: str):
    """Get a specific example by ID."""
    if example_id not in _examples:
        raise HTTPException(status_code=404, detail="Example not found")
    return _examples[example_id]


@router.put("/{example_id}", response_model=ExampleResponse)
async def update_example(example_id: str, request: ExampleUpdateRequest):
    """Update an existing example."""
    if example_id not in _examples:
        raise HTTPException(status_code=404, detail="Example not found")
    
    example = _examples[example_id]
    
    if request.name is not None:
        example["name"] = request.name
    if request.value is not None:
        example["value"] = request.value
    if request.description is not None:
        example["description"] = request.description
    if request.tags is not None:
        example["tags"] = request.tags
    
    example["updated_at"] = datetime.utcnow().isoformat() + "Z"
    
    return example


@router.delete("/{example_id}", status_code=204)
async def delete_example(example_id: str):
    """Delete an example."""
    if example_id not in _examples:
        raise HTTPException(status_code=404, detail="Example not found")
    del _examples[example_id]
    return None
EOF
```

### Step 4: Create Model Definitions

Request models:

```bash
cat > api_fastapi/models/requests.py.jinja << 'EOF'
"""Request models for API endpoints."""
from pydantic import BaseModel, Field, field_validator


class ExampleCreateRequest(BaseModel):
    """Request model for creating an example."""
    
    name: str = Field(..., min_length=1, max_length=100, description="Example name")
    value: int = Field(..., ge=0, description="Non-negative integer value")
    description: str | None = Field(None, max_length=500, description="Optional description")
    tags: list[str] | None = Field(None, max_length=10, description="Optional tags")
    
    @field_validator("name")
    @classmethod
    def name_must_not_be_whitespace(cls, v: str) -> str:
        """Validate name is not empty or whitespace."""
        if not v.strip():
            raise ValueError("Name cannot be whitespace only")
        return v.strip()
    
    @field_validator("tags")
    @classmethod
    def validate_tags(cls, v: list[str] | None) -> list[str] | None:
        """Validate each tag length."""
        if v is not None:
            for tag in v:
                if not 1 <= len(tag) <= 50:
                    raise ValueError("Each tag must be 1-50 characters")
        return v


class ExampleUpdateRequest(BaseModel):
    """Request model for updating an example."""
    
    name: str | None = Field(None, min_length=1, max_length=100)
    value: int | None = Field(None, ge=0)
    description: str | None = Field(None, max_length=500)
    tags: list[str] | None = Field(None, max_length=10)
EOF
```

Response models:

```bash
cat > api_fastapi/models/responses.py.jinja << 'EOF'
"""Response models for API endpoints."""
from pydantic import BaseModel


class ExampleResponse(BaseModel):
    """Response model for example entities."""
    
    id: str
    name: str
    value: int
    description: str | None = None
    tags: list[str]
    created_at: str
    updated_at: str


class ErrorResponse(BaseModel):
    """Standard error response model."""
    
    detail: str | list[dict]
    status_code: int | None = None
    request_id: str | None = None
EOF
```

### Step 5: Create Test Files

```bash
cat > api_fastapi/tests/conftest.py.jinja << 'EOF'
"""Pytest fixtures for API testing."""
import pytest
from fastapi.testclient import TestClient

from {{ package_name }}.api.main import app


@pytest.fixture
def client():
    """FastAPI test client fixture."""
    return TestClient(app)
EOF

cat > api_fastapi/tests/test_health.py.jinja << 'EOF'
"""Tests for health check endpoints."""
def test_health_check(client):
    """Test main health check endpoint."""
    response = client.get("/health/")
    assert response.status_code == 200
    data = response.json()
    assert data["status"] == "healthy"
    assert "version" in data
    assert "timestamp" in data


def test_readiness_check(client):
    """Test readiness probe."""
    response = client.get("/health/ready")
    assert response.status_code == 200
    assert response.json()["status"] == "ready"


def test_liveness_check(client):
    """Test liveness probe."""
    response = client.get("/health/live")
    assert response.status_code == 200
    assert response.json()["status"] == "alive"
EOF

cat > api_fastapi/tests/test_examples.py.jinja << 'EOF'
"""Tests for example CRUD endpoints."""
def test_list_examples_empty(client):
    """Test listing examples when none exist."""
    response = client.get("/examples/")
    assert response.status_code == 200
    assert response.json() == []


def test_create_example(client):
    """Test creating an example."""
    payload = {"name": "Test", "value": 42}
    response = client.post("/examples/", json=payload)
    assert response.status_code == 201
    data = response.json()
    assert data["name"] == "Test"
    assert data["value"] == 42
    assert "id" in data
    assert "created_at" in data


def test_create_example_validation_error(client):
    """Test validation error on invalid input."""
    payload = {"name": "", "value": -1}
    response = client.post("/examples/", json=payload)
    assert response.status_code == 422


def test_get_example(client):
    """Test retrieving a specific example."""
    # Create example first
    create_response = client.post("/examples/", json={"name": "Test", "value": 42})
    example_id = create_response.json()["id"]
    
    # Get example
    response = client.get(f"/examples/{example_id}")
    assert response.status_code == 200
    assert response.json()["id"] == example_id


def test_get_example_not_found(client):
    """Test 404 for nonexistent example."""
    response = client.get("/examples/nonexistent-id")
    assert response.status_code == 404


def test_update_example(client):
    """Test updating an example."""
    # Create example
    create_response = client.post("/examples/", json={"name": "Test", "value": 42})
    example_id = create_response.json()["id"]
    
    # Update example
    update_payload = {"name": "Updated", "value": 100}
    response = client.put(f"/examples/{example_id}", json=update_payload)
    assert response.status_code == 200
    data = response.json()
    assert data["name"] == "Updated"
    assert data["value"] == 100


def test_delete_example(client):
    """Test deleting an example."""
    # Create example
    create_response = client.post("/examples/", json={"name": "Test", "value": 42})
    example_id = create_response.json()["id"]
    
    # Delete example
    response = client.delete(f"/examples/{example_id}")
    assert response.status_code == 204
    
    # Verify deleted
    get_response = client.get(f"/examples/{example_id}")
    assert get_response.status_code == 404
EOF
```

## Phase 2: Test the Scaffold

### Step 6: Render a Test Project

```bash
# From repository root
./scripts/render-samples.sh --variant fastapi-test --answers samples/fastapi-test/copier-answers.yml

# Navigate to rendered project
cd samples/fastapi-test/render
```

### Step 7: Install Dependencies and Run

```bash
# Sync dependencies (including FastAPI)
uv sync --extra api

# Start the development server
uv run uvicorn {package_name}.api.main:app --reload --host 0.0.0.0 --port 8000
```

**Expected Output**:

```text
INFO:     Started server process [12345]
INFO:     Waiting for application startup.
INFO:     Application startup complete.
INFO:     Uvicorn running on http://0.0.0.0:8000 (Press CTRL+C to quit)
```

### Step 8: Validate Endpoints

Open another terminal and test the API:

```bash
# Test health check
curl http://localhost:8000/health/
# Expected: {"status":"healthy","version":"0.1.0","timestamp":"..."}

# Test root endpoint
curl http://localhost:8000/
# Expected: {"message":"Welcome to...","version":"0.1.0","docs":"/docs"}

# Create an example
curl -X POST http://localhost:8000/examples/ \
  -H "Content-Type: application/json" \
  -d '{"name":"Test","value":42}'
# Expected: 201 Created with example data

# List examples
curl http://localhost:8000/examples/
# Expected: Array with created example

# Access interactive docs
open http://localhost:8000/docs
# Expected: Swagger UI with all endpoints documented
```

### Step 9: Run Tests

```bash
# Run pytest
uv run pytest tests/api/ -v

# Run with coverage
uv run pytest tests/api/ --cov={package_name}.api --cov-report=term-missing
```

**Expected Output**:

```text
tests/api/test_health.py::test_health_check PASSED
tests/api/test_health.py::test_readiness_check PASSED
tests/api/test_health.py::test_liveness_check PASSED
tests/api/test_examples.py::test_list_examples_empty PASSED
tests/api/test_examples.py::test_create_example PASSED
tests/api/test_examples.py::test_create_example_validation_error PASSED
tests/api/test_examples.py::test_get_example PASSED
tests/api/test_examples.py::test_get_example_not_found PASSED
tests/api/test_examples.py::test_update_example PASSED
tests/api/test_examples.py::test_delete_example PASSED

========== 10 passed in 0.5s ==========
Coverage: 95%
```

### Step 10: Run Quality Checks

```bash
# Run full quality suite
make quality

# Or with uv tasks
QUALITY_PROFILE=standard uv run task quality
```

**Expected**: All quality checks (ruff, mypy, pylint, pytest) pass without errors

## Phase 3: Validate Success Criteria

### SC-001: Render to Running Server <2 Minutes ✓

```bash
# Time the full workflow
time (./scripts/render-samples.sh && cd samples/fastapi-test/render && uv sync --extra api && uv run uvicorn {package_name}.api.main:app &)
# Expected: <120 seconds
```

### SC-002: Pass Quality Checks ✓

```bash
# Verify quality suite passes
uv run task quality
# Expected: Exit code 0
```

### SC-003: Auto Documentation ✓

```bash
# Verify OpenAPI docs accessible
curl http://localhost:8000/openapi.json | jq '.paths | keys'
# Expected: Array of all endpoint paths
```

### SC-004: Add Endpoint <5 Minutes ✓

```bash
# Create new route file
cat > {package_name}/api/routes/status.py << 'EOF'
from fastapi import APIRouter
router = APIRouter(prefix="/status", tags=["Status"])

@router.get("/")
async def get_status():
    return {"status": "operational"}
EOF

# Register in main.py
# Add: from {package_name}.api.routes import status
# Add: app.include_router(status.router)

# Verify endpoint works
curl http://localhost:8000/status/
# Expected: {"status":"operational"}
```

### SC-005: Startup <3 Seconds ✓

```bash
# Measure startup time
time uv run python -c "from {package_name}.api.main import app"
# Expected: <3 seconds
```

### SC-006-009: Performance & Coverage ✓

Validated through test suite and load testing (if needed)

## Troubleshooting

### Issue: Import errors

**Solution**: Ensure `__init__.py` files exist in all directories

### Issue: Port already in use

**Solution**: Change port in .env or use different port:

```bash
uv run uvicorn {package_name}.api.main:app --port 8001
```

### Issue: CORS errors in browser

**Solution**: Update `cors_origins` in .env:

```bash
CORS_ORIGINS='["http://localhost:3000","http://localhost:8080"]'
```

## Next Steps

1. Update copier.yml with api_tracks prompt
2. Create documentation (docs/modules/api-fastapi.md.jinja)
3. Add Docker support (Dockerfile with FastAPI)
4. Regenerate all sample renders
5. Run full CI/CD validation
6. Create pull request with evidence

## Success Validation Checklist

- [ ] Template files created in `template/files/python/api_fastapi/`
- [ ] Test render generates working FastAPI application
- [ ] Server starts in <3 seconds
- [ ] All health check endpoints respond correctly
- [ ] Example CRUD endpoints work as expected
- [ ] Interactive documentation accessible at /docs
- [ ] All tests pass with ≥80% coverage
- [ ] Quality checks (ruff, mypy, pylint) pass
- [ ] Can add new endpoint in <5 minutes
- [ ] Constitution compliance validated

**Implementation Complete**: Once all checkboxes are marked, the FastAPI scaffold is ready for integration into the Riso template.
