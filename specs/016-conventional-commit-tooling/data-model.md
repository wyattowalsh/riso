# Data Model: Conventional Commit Tooling Integration

**Feature**: 016-conventional-commit-tooling  
**Phase**: 1 - Design & Contracts  
**Date**: 2025-11-02

## Overview

This feature's data model focuses on commit message structure, validation rules, and configuration entities. There is no persistent database storage - all data is either transient (commit messages during validation) or version-controlled (configuration files).

---

## Entity: CommitMessage

**Description**: Represents a Git commit message being validated or authored. Parsed into structured components for validation against conventional commit format.

### Attributes

| Attribute | Type | Required | Description | Validation Rules |
|-----------|------|----------|-------------|------------------|
| raw_text | string | Yes | Full commit message text from Git | UTF-8 encoded, max 10KB |
| header | string | Yes | First line (type, scope, subject) | Max 72 chars |
| type | string | Yes | Commit type (feat, fix, docs, etc.) | Must match configured types |
| scope | string | No | Optional scope namespace | Must match configured scopes if present, max 20 chars |
| subject | string | Yes | Short description | Max 72 chars (including type/scope), start with lowercase |
| body | string | No | Optional detailed description | Wrapped at 72 chars, separated by blank line from header |
| footer | string | No | Optional metadata (BREAKING CHANGE, refs) | Separated by blank line from body |
| is_breaking | boolean | Yes | Whether commit indicates breaking change | Derived from "!" or "BREAKING CHANGE:" |
| is_merge | boolean | Yes | Whether this is a merge commit | Detected by "Merge" prefix |

### Relationships

- Validated against **ValidationRuleSet**
- Generated by **GuidedAuthoringSession** (optional)
- Logged by **ValidationLogger**

### State Transitions

```text
CREATED → PARSING → VALIDATED/INVALID → LOGGED
```

1. **CREATED**: Raw text received from Git hook or CLI
2. **PARSING**: Split into components (type, scope, subject, body, footer)
3. **VALIDATED**: All rules pass, commit allowed
4. **INVALID**: One or more rules fail, commit rejected with errors
5. **LOGGED**: Validation result recorded (if logging enabled)

### Example

```yaml
raw_text: |
  feat(api): add user authentication endpoint

  Implements OAuth2 flow with JWT tokens.
  Adds middleware for protected routes.

  BREAKING CHANGE: Changes /login endpoint signature
type: feat
scope: api
subject: add user authentication endpoint
body: |
  Implements OAuth2 flow with JWT tokens.
  Adds middleware for protected routes.
footer: "BREAKING CHANGE: Changes /login endpoint signature"
is_breaking: true
is_merge: false
```

---

## Entity: ValidationRule

**Description**: Represents a single validation rule checking commit message format. Rules are loaded from configuration and executed during validation.

### Attributes

| Attribute | Type | Required | Description | Validation Rules |
|-----------|------|----------|-------------|------------------|
| rule_name | string | Yes | Unique identifier (e.g., "type-enum") | kebab-case, max 50 chars |
| severity_level | enum | Yes | error \| warning | "error" blocks commit, "warning" logs only |
| rule_type | enum | Yes | format \| enum \| pattern \| length | Determines validation logic |
| parameters | object | Yes | Rule-specific config | Varies by rule_type |
| error_message_template | string | Yes | Template for error messages | Jinja2 syntax with {placeholders} |
| suggested_fix | string | No | Help text for fixing violation | Max 200 chars |

### Rule Types

**format**: Checks overall structure

- Parameters: `pattern` (regex), `required_sections` (array)
- Example: Header must match `^(type)(\\(scope\\))?: (.{1,72})$`

**enum**: Checks value against allowed list

- Parameters: `allowed_values` (array), `case_sensitive` (bool)
- Example: Type must be one of [feat, fix, docs, ...]

**pattern**: Checks value against regex

- Parameters: `regex` (string), `flags` (string)
- Example: Subject must match `^[a-z].*` (start with lowercase)

**length**: Checks character count

- Parameters: `min` (int), `max` (int)
- Example: Subject length ≤ 72 chars

### Example

```yaml
rule_name: type-enum
severity_level: error
rule_type: enum
parameters:
  allowed_values: [feat, fix, docs, style, refactor, test, chore]
  case_sensitive: true
error_message_template: "Invalid type '{value}'. Must be one of: {allowed_values}"
suggested_fix: "Use 'feat' for new features, 'fix' for bug fixes"
```

---

## Entity: ValidationRuleSet

**Description**: Collection of validation rules loaded from configuration. Represents the complete validation policy for a project.

### Attributes

| Attribute | Type | Required | Description | Validation Rules |
|-----------|------|----------|-------------|------------------|
| config_source | string | Yes | Path to config file | Must exist and be readable |
| profile | enum | Yes | standard \| strict | Determines which rules are active |
| rules | array[ValidationRule] | Yes | List of validation rules | Max 50 rules |
| custom_types | array[string] | No | User-defined commit types | Max 20 custom types |
| custom_scopes | array[string] | No | User-defined scopes | Max 50 scopes (FR-025) |
| scope_descriptions | dict | No | Help text for each scope | key=scope, value=description |

### Relationships

- Contains multiple **ValidationRule** instances
- Used by **CommitValidator** for validation
- Referenced by **GuidedAuthoringSession** for prompts

### Example

```yaml
config_source: /path/to/project/.commitlintrc.yml
profile: standard
rules:
  - { rule_name: type-enum, severity_level: error, ... }
  - { rule_name: subject-case, severity_level: warning, ... }
custom_types: [perf, security]
custom_scopes: [api, cli, docs, core, web, mobile]
scope_descriptions:
  api: "Backend API endpoints"
  cli: "Command-line interface"
  web: "Web frontend application"
```

---

## Entity: GuidedAuthoringSession

**Description**: Interactive CLI session for authoring commit messages. Prompts user for each component and constructs valid CommitMessage.

### Attributes

| Attribute | Type | Required | Description | Validation Rules |
|-----------|------|----------|-------------|------------------|
| session_id | string | Yes | Unique session identifier | UUID v4 |
| ruleset | ValidationRuleSet | Yes | Rules for prompt validation | Must be loaded |
| current_step | enum | Yes | type \| scope \| subject \| body \| footer \| confirm | State machine |
| collected_data | dict | Yes | Accumulated responses | Partial CommitMessage structure |
| autocomplete_enabled | boolean | Yes | Whether to use fuzzy search | True if scopes > 10 (FR-026) |
| start_time | timestamp | Yes | Session start | ISO 8601 format |

### Relationships

- Uses **ValidationRuleSet** for prompt options and validation
- Produces **CommitMessage** on completion
- Creates **ValidationLogEntry** for audit trail

### State Transitions

```text
INIT → TYPE_PROMPT → SCOPE_PROMPT → SUBJECT_PROMPT → BODY_PROMPT → FOOTER_PROMPT → CONFIRM → COMPLETE/CANCELLED
```

1. **INIT**: Load ruleset, initialize autocomplete if needed
2. **TYPE_PROMPT**: Select commit type from allowed values
3. **SCOPE_PROMPT**: Optional scope selection (with fuzzy search if >10)
4. **SUBJECT_PROMPT**: Enter subject with live character count
5. **BODY_PROMPT**: Optional detailed description
6. **FOOTER_PROMPT**: Optional footer (breaking changes, refs)
7. **CONFIRM**: Preview full message, confirm/edit
8. **COMPLETE**: Write commit message, exit success
9. **CANCELLED**: User aborted, exit with warning

### Performance Requirements

- Autocomplete response time: <100ms for 50 scopes (per SC-009, Scalability Constraints)
- Fuzzy match algorithm: Levenshtein distance or similar
- Session timeout: None (blocking CLI operation)

---

## Entity: ValidationLogEntry

**Description**: Structured log record for validation events. Used for troubleshooting and audit trails.

### Attributes

| Attribute | Type | Required | Description | Validation Rules |
|-----------|------|----------|-------------|------------------|
| timestamp | datetime | Yes | When validation occurred | ISO 8601 format with microseconds |
| level | enum | Yes | ERROR \| WARNING \| INFO \| DEBUG | Maps to logging verbosity |
| component | enum | Yes | hook \| cli \| ci | Identifies validation context |
| commit_sha | string | No | Git commit SHA (if available) | 40-char hex string |
| message | string | Yes | Human-readable description | Max 500 chars |
| rule_violated | string | No | Rule name (if validation failed) | References ValidationRule.rule_name |
| suggested_fix | string | No | Auto-suggested correction | Max 200 chars |
| context | dict | No | Additional metadata | JSON-serializable |

### Verbosity Levels

**Normal** (level=ERROR only):

- Log only validation failures
- Output to stderr
- Minimal context

**Verbose** (level=ERROR, WARNING, INFO):

- Log validation failures + successful validations + warnings
- Include rule_violated and suggested_fix
- Output to stderr + optional log file

**Debug** (all levels):

- Log all validation checks, config parsing, hook execution
- Include full context dict
- Output to log file required

### Example

```json
{
  "timestamp": "2025-11-02T15:30:45.123456Z",
  "level": "ERROR",
  "component": "hook",
  "commit_sha": "a1b2c3d4e5f6...",
  "message": "Commit message validation failed",
  "rule_violated": "type-enum",
  "suggested_fix": "Use 'feat' for new features",
  "context": {
    "input": "featrue: add endpoint",
    "expected_types": ["feat", "fix", "docs", ...],
    "actual_type": "featrue"
  }
}
```

---

## Entity: HookInstallationRecord

**Description**: Metadata about Git hook installation. Used for diagnostics and graceful degradation.

### Attributes

| Attribute | Type | Required | Description | Validation Rules |
|-----------|------|----------|-------------|------------------|
| installed_at | timestamp | Yes | Installation timestamp | ISO 8601 format |
| hook_path | string | Yes | Absolute path to hook file | Must be .git/hooks/commit-msg |
| installer_version | string | Yes | Script version | Semantic version (e.g., "1.0.0") |
| validation_backend | enum | Yes | node \| python | Detected at install time |
| installation_status | enum | Yes | success \| failed \| skipped | Reflects installation outcome |
| failure_reason | string | No | Error message (if failed) | Max 500 chars |
| recovery_steps | array[string] | No | Manual installation instructions | Ordered list |

### Relationships

- Created by hook installation script
- Referenced by **ValidationLogger** for context
- Used by diagnostics/troubleshooting commands

### Example

```yaml
installed_at: "2025-11-02T10:00:00Z"
hook_path: /Users/dev/project/.git/hooks/commit-msg
installer_version: "1.0.0"
validation_backend: python
installation_status: success
failure_reason: null
recovery_steps: []
```

---

## Entity: ConfigurationProfile

**Description**: Named set of validation rules and settings. Template provides "standard" and "strict" profiles.

### Attributes

| Attribute | Type | Required | Description | Validation Rules |
|-----------|------|----------|-------------|------------------|
| profile_name | string | Yes | Unique identifier | standard \| strict |
| extends | string | No | Base profile to inherit from | Must reference existing profile |
| rules_override | dict | No | Rule modifications | key=rule_name, value=severity or params |
| custom_types | array[string] | No | Additional allowed types | Max 20 |
| custom_scopes | array[string] | No | Additional allowed scopes | Max 50 |
| performance_settings | dict | No | Timeout/cache configuration | See below |

### Profile Comparison

| Setting | Standard | Strict |
|---------|----------|--------|
| type-enum | error | error |
| scope-enum | warning | error |
| subject-case | off | error (lowercase-only) |
| subject-max-length | 72 | 50 |
| body-leading-blank | error | error |
| footer-leading-blank | error | error |
| hook-execution-timeout | 1000ms | 500ms |

### Example

```yaml
profile_name: strict
extends: standard
rules_override:
  subject-case: [2, always, lower-case]
  subject-max-length: [2, always, 50]
  scope-enum: [2, always]  # Upgrade from warning to error
performance_settings:
  hook_timeout_ms: 500
  config_cache_ttl_seconds: 60
```

---

## Data Flow

### Validation Flow (Hook-based)

```text
1. Developer runs `git commit`
2. Git invokes .git/hooks/commit-msg with message file path
3. Hook script reads message → creates CommitMessage entity
4. Load ValidationRuleSet from .commitlintrc.yml
5. Iterate through rules, check CommitMessage attributes
6. If any error-level rule fails:
   - Create ValidationLogEntry (ERROR)
   - Display error message + suggested fix
   - Exit with code 1 (commit rejected)
7. If all rules pass:
   - Create ValidationLogEntry (INFO, if verbose mode)
   - Exit with code 0 (commit allowed)
```

### Guided Authoring Flow

```text
1. Developer runs `uv run commit` or `pnpm run commit`
2. Initialize GuidedAuthoringSession
3. Load ValidationRuleSet
4. Prompt for type (enum from ruleset.custom_types)
5. Prompt for scope (if scopes > 10, enable autocomplete)
6. Prompt for subject (live validation against max length)
7. Optional: Prompt for body
8. Optional: Prompt for footer/breaking changes
9. Display preview of full message
10. Confirm → create CommitMessage
11. Validate against ruleset
12. If valid: execute `git commit -m "$message"`
13. If invalid: show errors, return to edit step
```

### CI Validation Flow

```text
1. GitHub Actions workflow triggered on PR
2. Fetch full commit history (fetch-depth: 0)
3. List all commits in PR: `git log base..head`
4. For each commit:
   a. Extract message: `git show -s --format=%B $SHA`
   b. Create CommitMessage entity
   c. Load ValidationRuleSet
   d. Validate against rules
   e. Create ValidationLogEntry
5. Aggregate results → pass/fail status
6. Upload validation report as artifact
7. If any commit invalid: fail workflow, post comment on PR
```

---

## Configuration Schema

### .commitlintrc.yml Structure

```yaml
# Required
extends:
  - '@commitlint/config-conventional'

# Optional: Rule customization
rules:
  # Format: [level, applicable, value]
  # level: 0=disable, 1=warning, 2=error
  # applicable: always | never
  type-enum:
    - 2  # error level
    - always
    - [feat, fix, docs, style, refactor, test, chore]
  
  scope-enum:
    - 1  # warning level
    - always
    - [api, cli, docs, core]  # Custom scopes
  
  subject-case:
    - 2
    - always
    - [sentence-case, start-case, lower-case]

# Optional: Commitizen prompts configuration
prompt:
  settings:
    scopeOverrides:
      feat:
        - api
        - cli
      fix:
        - api
        - core
    
  messages:
    type: "Select the type of change:"
    scope: "Denote the scope of this change:"
    subject: "Write a short description:"
    body: "Provide a longer description (optional):"
    breaking: "List any breaking changes (optional):"
    footer: "List any issue references (optional):"
```

### Validation

- Max file size: 10KB
- Max scopes: 50 (enforced by Jinja2 template during render)
- Max custom types: 20
- Must extend config-conventional (baseline rules)

---

## Performance Considerations

### Caching Strategy

- **Configuration**: Cache parsed .commitlintrc.yml for 60 seconds (avoid re-parsing on rapid commits)
- **Scopes**: Cache scope list for autocomplete (invalidate on config change)
- **No persistent cache**: All caching in-memory, no disk writes

### Memory Constraints

- **CommitMessage**: ~2KB average (10KB max)
- **ValidationRuleSet**: ~5KB (10KB max with 50 scopes)
- **Total hook overhead**: <1MB memory footprint

### Latency Targets

Per Technical Constraints (spec):

- Hook execution: <500ms (target), <1000ms (max)
- CLI startup: <2000ms
- Config parsing: <100ms
- Autocomplete: <100ms for 50 scopes
- Logging overhead: <50ms (normal mode)

---

### Security Considerations

### Input Validation

- **Commit messages**: Sanitize before regex matching (prevent ReDoS attacks)
- **Configuration files**: Validate schema before loading (prevent code injection)
- **Hook scripts**: No eval() or exec() of user input (Security Constraints in spec.md)

### File Permissions

- **Hook files**: Executable by user only (0700), no world-writable
- **Config files**: Read-only in production (0644)
- **Log files**: User-writable only (0600 if verbose/debug mode)

### Denial of Service

- **Regex timeouts**: Maximum 100ms per regex match
- **Message size limits**: Reject commits >10KB (prevent memory exhaustion)
- **Rule count limits**: Maximum 50 rules per ruleset

---

## Summary

This data model defines six core entities:

1. **CommitMessage**: Transient, structured representation of commit text
2. **ValidationRule**: Configuration-driven rule for format checking
3. **ValidationRuleSet**: Collection of rules + project-specific types/scopes
4. **GuidedAuthoringSession**: Interactive CLI state machine for commit authoring
5. **ValidationLogEntry**: Structured log record for troubleshooting
6. **HookInstallationRecord**: Installation metadata for diagnostics
7. **ConfigurationProfile**: Named rule sets (standard/strict)

All entities are in-memory (no database). Configuration persists in version-controlled YAML files. Logging is optional and outputs to stderr or files.
