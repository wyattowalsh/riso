# Implementation Plan: Container & Deployment Templates

**Branch**: `005-container-deployment` | **Date**: 2025-11-01 | **Spec**: [spec.md](spec.md)
**Input**: Feature specification from `/specs/005-container-deployment/spec.md`

**Note**: This file generated by `/speckit.plan` command.

## Summary

Deliver production-ready Docker containerization and deployment infrastructure for Riso-generated projects. Provide Dockerfile templates with multi-stage builds, security hardening (non-root UID 1000:1000, minimal base images), and HTTP health checks (/health endpoint, 5s timeout, 3 retries). Implement docker-compose orchestration for monorepo layouts with conditional database services (PostgreSQL/Redis) controlled by explicit copier prompt. Extend GitHub Actions CI/CD (feature 004) with container build/scan/publish workflows supporting ghcr.io, Docker Hub, and AWS ECR with Trivy security scanning, semantic versioning, and SBOM generation.

## Technical Context

**Language/Version**: Python 3.11+ (uv-managed), Node.js 20 LTS (pnpm-managed), Jinja2 templating  
**Primary Dependencies**: Docker Engine 24+, Docker Compose v2, Docker Buildx, hadolint, Trivy/Grype, existing GitHub Actions infrastructure (feature 004)  
**Storage**: Container registries (ghcr.io, Docker Hub, AWS ECR), GitHub Actions artifact storage (90-day retention)  
**Testing**: docker build validation, container smoke tests, hadolint linting, Trivy security scanning, docker-compose health checks  
**Target Platform**: Docker Engine 24+, Docker Compose v2, Kubernetes 1.28+, GitHub Actions (macOS/Ubuntu runners)  
**Project Type**: Copier template / Code generation (extends existing Riso template)  
**Performance Goals**: Docker builds <3min (Python), <5min (Python+Node monorepos), images <500MB (Python), <300MB (Node), <200MB (docs), docker-compose startup <30s  
**Constraints**: Non-root execution (UID 1000:1000), zero HIGH/CRITICAL vulnerabilities, hadolint compliance, GitHub Actions free tier optimization, conditional database rendering  
**Scale/Scope**: ~8 template files (Dockerfile variants, docker-compose, dockerignore, workflows), 4 sample variants validation, 50-60 implementation tasks

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

- ✅ **Template Sovereignty**: Container templates live in `template/files/shared/.docker/Dockerfile.jinja`, `template/files/shared/docker-compose.yml.jinja`, `template/files/shared/.dockerignore.jinja`, `template/files/shared/.github/workflows/riso-container-*.yml.jinja`, and `.github/context/containers.md`; prove via regenerated samples and `copier diff`.

- ✅ **Deterministic Generation**: Extend `scripts/render-samples.sh` to build containers for all variants (`default`, `cli-docs`, `api-monorepo`, `full-stack`), validate with hadolint/Trivy, test docker-compose orchestration, capture build times/image sizes in `samples/*/metadata.json`; update `scripts/ci/render_matrix.py` to include container validation steps.

- ✅ **Minimal Baseline, Optional Depth**: Baseline (`api_tracks=none`, `cli_module=disabled`) gets minimal Python runtime Dockerfile; API projects get production configs with health checks; databases (PostgreSQL/Redis) only rendered when `include_databases=yes` prompt answered AND `api_tracks` includes python/node; CLI-only and docs-only projects exclude docker-compose databases.

- ✅ **Documented Scaffolds**: Update `docs/quickstart.md.jinja` with container build commands, health check validation, docker-compose usage; create `docs/modules/containers.md.jinja` covering Dockerfile structure, multi-stage builds, security hardening, registry publishing patterns; add `.github/context/containers.md` with extension patterns for custom builds, multi-arch, private registries, troubleshooting.

- ✅ **Automation-Governed Compliance**: Add `scripts/ci/validate_dockerfiles.py` (hadolint validation), extend `scripts/render-samples.sh` with container builds and health checks, update `.github/workflows/template-ci.yml` with container validation job, integrate Trivy scanning into container workflows, upload build logs/scan reports/SBOMs as artifacts (90-day retention).

## Project Structure

### Documentation (this feature)

```text
specs/[###-feature]/
├── plan.md              # This file (/speckit.plan command output)
├── research.md          # Phase 0 output (/speckit.plan command)
├── data-model.md        # Phase 1 output (/speckit.plan command)
├── quickstart.md        # Phase 1 output (/speckit.plan command)
├── contracts/           # Phase 1 output (/speckit.plan command)
└── tasks.md             # Phase 2 output (/speckit.tasks command - NOT created by /speckit.plan)
```

### Source Code (repository root)

```text
template/
├── copier.yml                              # Add include_databases prompt
├── files/
│   ├── shared/
│   │   ├── .docker/
│   │   │   ├── Dockerfile.jinja            # Multi-stage build with conditional modules
│   │   │   └── Dockerfile.dev.jinja        # Development variant (optional)
│   │   ├── .dockerignore.jinja             # Exclude dev artifacts
│   │   ├── docker-compose.yml.jinja        # Multi-service orchestration
│   │   ├── .hadolint.yaml.jinja            # Linting configuration
│   │   ├── .github/
│   │   │   ├── context/
│   │   │   │   └── containers.md           # Extension patterns
│   │   │   └── workflows/
│   │   │       ├── riso-container-build.yml.jinja
│   │   │       └── riso-container-publish.yml.jinja
│   │   └── docs/
│   │       └── modules/
│   │           └── containers.md.jinja     # Module documentation
│   ├── python/
│   │   └── src/{{ package_name }}/
│   │       └── api/
│   │           └── health.py.jinja         # Health check endpoint
│   └── node/
│       └── apps/api-node/
│           └── src/
│               └── health.ts.jinja         # Health check endpoint

scripts/
├── render-samples.sh                       # Extended with container builds
└── ci/
    ├── validate_dockerfiles.py             # Hadolint validation script
    └── render_matrix.py                    # Extended with container metrics

samples/
├── default/
│   ├── metadata.json                       # Add container build metrics
│   └── render/
│       ├── Dockerfile                      # Rendered container
│       └── .dockerignore
├── cli-docs/
│   └── [same structure]
├── api-monorepo/
│   └── render/
│       ├── Dockerfile
│       └── docker-compose.yml              # Multi-service orchestration
└── full-stack/
    └── render/
        ├── Dockerfile
        └── docker-compose.yml              # Full stack with optional databases

docs/
├── quickstart.md.jinja                     # Add container quickstart section
└── modules/
    └── containers.md.jinja                 # New module documentation
```

**Structure Decision**: Extends existing Riso template structure with container-specific templates in `template/files/shared/.docker/` and workflows in `.github/workflows/`. Follows established pattern of conditional Jinja rendering based on copier prompts (`api_tracks`, `cli_module`, `docs_site`, `include_databases`). Docker-related files placed in shared directory for accessibility across all module combinations. Health check endpoints added to Python/Node API modules.

## Complexity Tracking

> **Fill ONLY if Constitution Check has violations that must be justified**

No constitution gate violations anticipated. Container templates follow established conditional rendering patterns from features 001-004. New `include_databases` prompt aligns with minimal baseline principle by making databases explicit opt-in. Multi-stage Dockerfiles and docker-compose complexity managed through clear documentation and smoke testing across all sample variants.
