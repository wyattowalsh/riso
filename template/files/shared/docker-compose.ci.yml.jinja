# Docker Compose override for CI/CD environments (GitHub Actions)
# This file is automatically applied when RISO_CI_MODE=true
# 
# Optimizations:
# - Disables volume mounts (uses baked-in code from image)
# - Reduces healthcheck intervals for faster startup
# - Optimizes for ephemeral runner environments
#
# Usage:
#   RISO_CI_MODE=true docker-compose -f docker-compose.yml -f docker-compose.ci.yml up -d

version: '3.8'

services:
{%- if api_tracks | lower in ["python", "python+node"] %}
  api-python:
    volumes: []  # Disable volume mounts - use image code
    healthcheck:
      interval: 1s  # Faster healthchecks in CI
      timeout: 3s
      retries: 5
    build:
      cache_from:
        - type=gha  # Use GitHub Actions cache
{%- endif %}

{%- if api_tracks | lower in ["node", "python+node"] %}
  api-node:
    volumes: []  # Disable volume mounts - use image code
    healthcheck:
      interval: 1s  # Faster healthchecks in CI
      timeout: 3s
      retries: 5
    build:
      cache_from:
        - type=gha  # Use GitHub Actions cache
{%- endif %}

{%- if docs_site == "fumadocs" %}
  docs-fumadocs:
    volumes: []  # Disable volume mounts - use image code
    healthcheck:
      interval: 2s  # Faster healthchecks in CI
      timeout: 3s
      retries: 5
    build:
      cache_from:
        - type=gha  # Use GitHub Actions cache
{%- endif %}

{%- if include_databases == "yes" and (api_tracks | lower in ["python", "node", "python+node"]) %}
  postgres:
    healthcheck:
      interval: 1s  # Faster healthchecks in CI
      timeout: 3s
      retries: 5
    tmpfs:
      - /var/lib/postgresql/data  # Use tmpfs for faster I/O in CI

  redis:
    healthcheck:
      interval: 1s  # Faster healthchecks in CI
      timeout: 3s
      retries: 5
    tmpfs:
      - /data  # Use tmpfs for faster I/O in CI
{%- endif %}
