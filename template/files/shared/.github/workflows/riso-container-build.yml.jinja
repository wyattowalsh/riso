name: Container Build

# Build and scan container images on pull requests
# Validates Dockerfile syntax, builds images, runs security scans
# Uploads artifacts (build logs, SBOM, scan reports) with 90-day retention

on:
  pull_request:
    branches: [main, develop]
    paths:
      - 'Dockerfile'
      - 'docker-compose.yml'
      - '.dockerignore'
      - '.hadolint.yaml'
      - 'src/**'
      - 'apps/**'
      - 'pyproject.toml'
      - 'uv.lock'
      - 'package.json'
      - 'pnpm-lock.yaml'
      - '.github/workflows/riso-container-*.yml'
  workflow_dispatch:

permissions:
  contents: read
  packages: read

jobs:
  hadolint:
    name: Lint Dockerfiles
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run hadolint
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: Dockerfile
          failure-threshold: error
          config: .hadolint.yaml

      - name: Lint docker-compose
        run: |
          docker-compose config --quiet

{%- if api_tracks | lower in ["python", "python+node"] %}

  build-python:
    name: Build Python Container
    runs-on: ubuntu-latest
    needs: [hadolint]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: {% raw %}${{ runner.os }}-buildx-python-${{ hashFiles('uv.lock') }}{% endraw %}
          restore-keys: |
            {% raw %}${{ runner.os }}-buildx-python-{% endraw %}

      - name: Build Python image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile
          target: runtime-python
          push: false
          tags: {% raw %}${{ github.repository }}{% endraw %}/api-python:{% raw %}${{ github.sha }}{% endraw %}
          cache-from: type=local,src=/tmp/.buildx-cache
          cache-to: type=local,dest=/tmp/.buildx-cache-new,mode=max
          load: true

      - name: Move cache
        run: |
          rm -rf /tmp/.buildx-cache
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache

      - name: Inspect image
        run: |
          docker images
          docker inspect {% raw %}${{ github.repository }}{% endraw %}/api-python:{% raw %}${{ github.sha }}{% endraw %}

      - name: Check image size
        run: |
          SIZE=$(docker images {% raw %}${{ github.repository }}{% endraw %}/api-python:{% raw %}${{ github.sha }}{% endraw %} --format "{% raw %}{{.Size}}{% endraw %}")
          echo "Image size: $SIZE"
          # Fail if > 500MB (requirement: Python <500MB)
          SIZE_MB=$(docker images {% raw %}${{ github.repository }}{% endraw %}/api-python:{% raw %}${{ github.sha }}{% endraw %} --format "{% raw %}{{.Size}}{% endraw %}" | sed 's/MB//')
          if (( $(echo "$SIZE_MB > 500" | bc -l) )); then
            echo "❌ Image exceeds 500MB target: ${SIZE_MB}MB"
            exit 1
          fi
          echo "✓ Image within 500MB target: ${SIZE_MB}MB"

      - name: Save image
        run: |
          docker save {% raw %}${{ github.repository }}{% endraw %}/api-python:{% raw %}${{ github.sha }}{% endraw %} -o python-image.tar

      - name: Upload image artifact
        uses: actions/upload-artifact@v4
        with:
          name: python-image
          path: python-image.tar
          retention-days: 90
{%- endif %}

{%- if api_tracks | lower in ["node", "python+node"] %}

  build-node:
    name: Build Node Container
    runs-on: ubuntu-latest
    needs: [hadolint]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: {% raw %}${{ runner.os }}-buildx-node-${{ hashFiles('pnpm-lock.yaml') }}{% endraw %}
          restore-keys: |
            {% raw %}${{ runner.os }}-buildx-node-{% endraw %}

      - name: Build Node image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile
          target: runtime-node
          push: false
          tags: {% raw %}${{ github.repository }}{% endraw %}/api-node:{% raw %}${{ github.sha }}{% endraw %}
          cache-from: type=local,src=/tmp/.buildx-cache
          cache-to: type=local,dest=/tmp/.buildx-cache-new,mode=max
          load: true

      - name: Move cache
        run: |
          rm -rf /tmp/.buildx-cache
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache

      - name: Check image size
        run: |
          SIZE_MB=$(docker images {% raw %}${{ github.repository }}{% endraw %}/api-node:{% raw %}${{ github.sha }}{% endraw %} --format "{% raw %}{{.Size}}{% endraw %}" | sed 's/MB//')
          echo "Image size: ${SIZE_MB}MB"
          # Fail if > 300MB (requirement: Node <300MB)
          if (( $(echo "$SIZE_MB > 300" | bc -l) )); then
            echo "❌ Image exceeds 300MB target: ${SIZE_MB}MB"
            exit 1
          fi
          echo "✓ Image within 300MB target: ${SIZE_MB}MB"

      - name: Save image
        run: |
          docker save {% raw %}${{ github.repository }}{% endraw %}/api-node:{% raw %}${{ github.sha }}{% endraw %} -o node-image.tar

      - name: Upload image artifact
        uses: actions/upload-artifact@v4
        with:
          name: node-image
          path: node-image.tar
          retention-days: 90
{%- endif %}

  scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: [{% if api_tracks | lower in ["python", "python+node"] %}build-python{% endif %}{% if api_tracks | lower == "python+node" %}, {% endif %}{% if api_tracks | lower in ["node", "python+node"] %}build-node{% endif %}]
    strategy:
      matrix:
        target:
{%- if api_tracks | lower in ["python", "python+node"] %}
          - { name: python, artifact: python-image, tag: api-python }
{%- endif %}
{%- if api_tracks | lower in ["node", "python+node"] %}
          - { name: node, artifact: node-image, tag: api-node }
{%- endif %}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download image
        uses: actions/download-artifact@v4
        with:
          name: {% raw %}${{ matrix.target.artifact }}{% endraw %}

      - name: Load image
        run: |
          docker load -i {% raw %}${{ matrix.target.artifact }}{% endraw %}.tar

      - name: Run Trivy scan
        uses: aquasecurity/trivy-action@0.20.0
        with:
          image-ref: {% raw %}${{ github.repository }}/${{ matrix.target.tag }}:${{ github.sha }}{% endraw %}
          format: 'sarif'
          output: 'trivy-results-{% raw %}${{ matrix.target.name }}{% endraw %}.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: '1'  # Fail on HIGH/CRITICAL vulnerabilities

      - name: Generate SBOM
        uses: aquasecurity/trivy-action@0.20.0
        with:
          image-ref: {% raw %}${{ github.repository }}/${{ matrix.target.tag }}:${{ github.sha }}{% endraw %}
          format: 'spdx-json'
          output: 'sbom-{% raw %}${{ matrix.target.name }}{% endraw %}.json'

      - name: Upload Trivy results
        uses: actions/upload-artifact@v4
        with:
          name: trivy-results-{% raw %}${{ matrix.target.name }}{% endraw %}
          path: |
            trivy-results-{% raw %}${{ matrix.target.name }}{% endraw %}.sarif
            sbom-{% raw %}${{ matrix.target.name }}{% endraw %}.json
          retention-days: 90

  summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [scan]
    if: always()
    steps:
      - name: Build summary
        run: |
          echo "## Container Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✓ Dockerfile linting passed" >> $GITHUB_STEP_SUMMARY
          echo "✓ Images built successfully" >> $GITHUB_STEP_SUMMARY
          echo "✓ Security scans completed" >> $GITHUB_STEP_SUMMARY
          echo "✓ Artifacts uploaded (90-day retention)" >> $GITHUB_STEP_SUMMARY
