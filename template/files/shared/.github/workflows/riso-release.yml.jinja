{% if changelog_module == "enabled" -%}
# GitHub Actions workflow for automated releases
# Generated by Riso template - Feature 014: Changelog & Release Management
name: Release

on:
  push:
    branches:
      - main
{% if project_layout == "monorepo" %}
      - beta
      - alpha
{% endif %}
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Run release in dry-run mode (no publishing)'
        required: false
        type: boolean
        default: false

concurrency:
  group: {% raw %}${{ github.workflow }}-${{ github.ref }}{% endraw %}
  cancel-in-progress: true

permissions:
  contents: write
  issues: write
  pull-requests: write
  packages: write

jobs:
  release:
    name: Semantic Release
    runs-on: ubuntu-latest
    needs: [quality]
    timeout-minutes: 20
    if: {% raw %}github.ref == 'refs/heads/main' || github.ref == 'refs/heads/beta' || github.ref == 'refs/heads/alpha'{% endraw %}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
{% if api_tracks in ['node', 'python+node'] %}
          cache: 'pnpm'
{% endif %}

{% if api_tracks in ['python', 'python+node'] %}
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '{{ python_versions[0] }}'

      - name: Install uv
        uses: astral-sh/setup-uv@v3
        with:
          version: "latest"
          enable-cache: true

      - name: Install Python dependencies
        run: |
          uv sync
{% endif %}

{% if api_tracks in ['node', 'python+node'] %}
      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 8

      - name: Install Node dependencies
        run: pnpm install --frozen-lockfile
{% else %}
      - name: Install semantic-release dependencies
        run: |
          npm install -g semantic-release @semantic-release/changelog @semantic-release/git @semantic-release/github @semantic-release/exec @semantic-release/commit-analyzer @semantic-release/release-notes-generator
{% endif %}

      - name: Verify release prerequisites
        run: |
          echo "Verifying Git configuration..."
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
{% if api_tracks in ['python', 'python+node'] %}
          echo "Verifying Python environment..."
          uv run python --version
          uv run python -c "import sys; print(f'Python {sys.version}')"
{% endif %}
          echo "Verifying semantic-release installation..."
{% if api_tracks in ['node', 'python+node'] %}
          npx semantic-release --version
{% else %}
          semantic-release --version
{% endif %}

      - name: Run semantic-release
        env:
{% raw %}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
{% if api_tracks in ['python', 'python+node'] %}
          PYPI_TOKEN: ${{ secrets.PYPI_TOKEN }}
{% endif %}
{% if api_tracks in ['node', 'python+node'] %}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
{% endif %}
          DOCKER_HUB_USERNAME: ${{ secrets.DOCKER_HUB_USERNAME }}
          DOCKER_HUB_TOKEN: ${{ secrets.DOCKER_HUB_TOKEN }}
          DRY_RUN: ${{ github.event.inputs.dry_run || 'false' }}
{% endraw %}
        run: |
{% if api_tracks in ['node', 'python+node'] %}
          if [ "$DRY_RUN" = "true" ]; then
            npx semantic-release --dry-run
          else
            npx semantic-release
          fi
{% else %}
          if [ "$DRY_RUN" = "true" ]; then
            semantic-release --dry-run
          else
            semantic-release
          fi
{% endif %}

      - name: Upload release artifacts
        if: {% raw %}success(){% endraw %}
        uses: actions/upload-artifact@v4
        with:
          name: release-artifacts
          path: |
{% if api_tracks in ['python', 'python+node'] %}
            dist/
{% endif %}
{% if api_tracks in ['node', 'python+node'] %}
            *.tgz
{% endif %}
            CHANGELOG.md
          retention-days: 90

      - name: Log release summary
        if: {% raw %}always(){% endraw %}
        run: |
          echo "## Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: {% raw %}${{ github.ref_name }}{% endraw %}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: {% raw %}${{ github.sha }}{% endraw %}" >> $GITHUB_STEP_SUMMARY
          echo "- **Dry Run**: $DRY_RUN" >> $GITHUB_STEP_SUMMARY
          if [ -f "CHANGELOG.md" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Latest Changelog Entry" >> $GITHUB_STEP_SUMMARY
            head -n 20 CHANGELOG.md >> $GITHUB_STEP_SUMMARY
          fi
{% endif %}
