{% if docs_site != 'none' and docs_quality_gates == 'enabled' %}
# Documentation build workflow
# Generated by Riso template (feature: 018-docs-sites-overhaul)
# Builds documentation and stores as artifact (90-day retention, max 500MB)

name: Documentation Build

on:
  push:
    branches: [main, develop]
    paths:
      - 'docs/**'
      - 'apps/docs-*/**'
      - '.github/workflows/riso-docs-build.yml'
  pull_request:
    paths:
      - 'docs/**'
      - 'apps/docs-*/**'
  workflow_dispatch:

jobs:
  build-docs:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      {% if docs_site == 'sphinx-shibuya' %}
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install uv
        run: pip install uv

      - name: Cache uv dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/uv
          key: ${{ runner.os }}-uv-${{ hashFiles('**/pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-uv-

      - name: Install dependencies
        run: uv sync --group docs

      - name: Build Sphinx documentation
        run: uv run make -f Makefile.docs docs
        env:
          SPHINXOPTS: "-W --keep-going"  # Treat warnings as errors but continue

      - name: Upload documentation artifact
        uses: actions/upload-artifact@v4
        with:
          name: sphinx-docs
          path: _build/html/
          retention-days: 90
          compression-level: 6

      {% elif docs_site == 'fumadocs' or docs_site == 'docusaurus' %}
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build documentation
        run: pnpm --filter docs-{{ docs_site }} build

      - name: Upload documentation artifact
        uses: actions/upload-artifact@v4
        with:
          name: {{ docs_site }}-docs
          path: {% if docs_site == 'fumadocs' %}apps/docs-fumadocs/out/{% else %}apps/docs-docusaurus/build/{% endif %}
          retention-days: 90
          compression-level: 6
      {% endif %}

      - name: Check artifact size
        run: |
          ARTIFACT_SIZE=$(du -sm {% if docs_site == 'sphinx-shibuya' %}_build/html{% elif docs_site == 'fumadocs' %}apps/docs-fumadocs/out{% else %}apps/docs-docusaurus/build{% endif %} | cut -f1)
          echo "Documentation artifact size: ${ARTIFACT_SIZE}MB"
          if [ "$ARTIFACT_SIZE" -gt 500 ]; then
            echo "::warning::Documentation artifact exceeds 500MB limit (${ARTIFACT_SIZE}MB)"
          fi

  # Deployment would be handled by separate workflow or deployment config
  # See docs/deploy/* for platform-specific configurations
{% endif %}
