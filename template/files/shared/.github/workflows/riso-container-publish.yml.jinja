name: Container Publish

# Publish container images to registries on main branch pushes and tags
# Supports: GitHub Container Registry (ghcr.io), Docker Hub, AWS ECR
# Tags images with semantic versions (v1.2.3, v1.2, v1, latest)

on:
  push:
    branches: [main]
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'
  workflow_dispatch:

concurrency:
  group: {% raw %}${{ github.workflow }}-${{ github.ref }}{% endraw %}
  cancel-in-progress: true

permissions:
  contents: read
  packages: write  # Required for ghcr.io publishing

jobs:
  publish-ghcr:
    name: Publish to GitHub Container Registry
    runs-on: ubuntu-latest
    strategy:
      matrix:
        target:
{%- if api_tracks | lower in ["python", "python+node"] %}
          - { name: python, dockerfile_target: runtime-python, image: api-python }
{%- endif %}
{%- if api_tracks | lower in ["node", "python+node"] %}
          - { name: node, dockerfile_target: runtime-node, image: api-node }
{%- endif %}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Required for git describe

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: {% raw %}${{ github.actor }}{% endraw %}
          password: {% raw %}${{ secrets.GITHUB_TOKEN }}{% endraw %}

      - name: Generate semantic version tags
        id: semver
        run: |
          # Try to get latest semver tag
          TAG=$(git describe --tags --match 'v[0-9]*' --abbrev=0 2>/dev/null || echo "")
          
          if [[ -z "$TAG" ]]; then
            echo "No semantic version tag found, using 'latest' only"
            echo "tags=ghcr.io/{% raw %}${{ github.repository_owner }}{% endraw %}/{% raw %}${{ matrix.target.image }}{% endraw %}:latest" >> $GITHUB_OUTPUT
            echo "::warning::No semantic version tag found. Consider tagging with 'v1.0.0' format."
          else
            # Validate semver format
            if [[ ! "$TAG" =~ ^v?[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
              echo "Invalid semver tag format: $TAG"
              echo "tags=ghcr.io/{% raw %}${{ github.repository_owner }}{% endraw %}/{% raw %}${{ matrix.target.image }}{% endraw %}:latest" >> $GITHUB_OUTPUT
              exit 0
            fi
            
            # Extract version components
            VERSION="${TAG#v}"  # Remove 'v' prefix
            MAJOR=$(echo $VERSION | cut -d. -f1)
            MINOR=$(echo $VERSION | cut -d. -f2)
            PATCH=$(echo $VERSION | cut -d. -f3)
            
            # Generate multiple tags
            TAGS="ghcr.io/{% raw %}${{ github.repository_owner }}{% endraw %}/{% raw %}${{ matrix.target.image }}{% endraw %}:latest"
            TAGS="$TAGS,ghcr.io/{% raw %}${{ github.repository_owner }}{% endraw %}/{% raw %}${{ matrix.target.image }}{% endraw %}:v${MAJOR}.${MINOR}.${PATCH}"
            TAGS="$TAGS,ghcr.io/{% raw %}${{ github.repository_owner }}{% endraw %}/{% raw %}${{ matrix.target.image }}{% endraw %}:v${MAJOR}.${MINOR}"
            TAGS="$TAGS,ghcr.io/{% raw %}${{ github.repository_owner }}{% endraw %}/{% raw %}${{ matrix.target.image }}{% endraw %}:v${MAJOR}"
            TAGS="$TAGS,ghcr.io/{% raw %}${{ github.repository_owner }}{% endraw %}/{% raw %}${{ matrix.target.image }}{% endraw %}:{% raw %}${{ github.sha }}{% endraw %}"
            
            echo "tags=$TAGS" >> $GITHUB_OUTPUT
            echo "Generated tags: $TAGS"
          fi

      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: {% raw %}${{ runner.os }}-buildx-${{ matrix.target.name }}-${{ hashFiles('**/uv.lock', '**/pnpm-lock.yaml') }}{% endraw %}
          restore-keys: |
            {% raw %}${{ runner.os }}-buildx-${{ matrix.target.name }}-{% endraw %}

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile
          target: {% raw %}${{ matrix.target.dockerfile_target }}{% endraw %}
          push: true
          tags: {% raw %}${{ steps.semver.outputs.tags }}{% endraw %}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          provenance: true
          sbom: true

      - name: Run Trivy scan on published image
        uses: aquasecurity/trivy-action@0.20.0
        with:
          image-ref: ghcr.io/{% raw %}${{ github.repository_owner }}/${{ matrix.target.image }}{% endraw %}:latest
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: '1'  # Fail if vulnerabilities found

      - name: Upload scan results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: trivy-scan-{% raw %}${{ matrix.target.name }}{% endraw %}
          path: trivy-results.sarif
          retention-days: 90

  # Optional: Publish to Docker Hub
  # Uncomment and configure secrets.DOCKERHUB_USERNAME and secrets.DOCKERHUB_TOKEN
  # publish-dockerhub:
  #   name: Publish to Docker Hub
  #   runs-on: ubuntu-latest
  #   if: false  # Set to true to enable
  #   strategy:
  #     matrix:
  #       target:
  # {%- if api_tracks | lower in ["python", "python+node"] %}
  #         - { name: python, dockerfile_target: runtime-python, image: api-python }
  # {%- endif %}
  # {%- if api_tracks | lower in ["node", "python+node"] %}
  #         - { name: node, dockerfile_target: runtime-node, image: api-node }
  # {%- endif %}
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4
  #
  #     - name: Set up Docker Buildx
  #       uses: docker/setup-buildx-action@v3
  #
  #     - name: Log in to Docker Hub
  #       uses: docker/login-action@v3
  #       with:
  #         username: {% raw %}${{ secrets.DOCKERHUB_USERNAME }}{% endraw %}
  #         password: {% raw %}${{ secrets.DOCKERHUB_TOKEN }}{% endraw %}
  #
  #     - name: Build and push
  #       uses: docker/build-push-action@v5
  #       with:
  #         context: .
  #         file: Dockerfile
  #         target: {% raw %}${{ matrix.target.dockerfile_target }}{% endraw %}
  #         push: true
  #         tags: {% raw %}${{ secrets.DOCKERHUB_USERNAME }}/${{ matrix.target.image }}{% endraw %}:latest
  #         cache-from: type=gha
  #         cache-to: type=gha,mode=max

  summary:
    name: Publish Summary
    runs-on: ubuntu-latest
    needs: [publish-ghcr]
    if: always()
    steps:
      - name: Publish summary
        run: |
          echo "## Container Publish Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✓ Images built and scanned" >> $GITHUB_STEP_SUMMARY
          echo "✓ Published to ghcr.io" >> $GITHUB_STEP_SUMMARY
          echo "✓ Semantic version tags generated" >> $GITHUB_STEP_SUMMARY
          echo "✓ SBOM and provenance attached" >> $GITHUB_STEP_SUMMARY
