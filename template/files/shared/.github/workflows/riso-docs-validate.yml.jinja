{% if docs_site != 'none' and docs_quality_gates == 'enabled' %}
# Documentation validation workflow
# Generated by Riso template (feature: 018-docs-sites-overhaul)
# Validates links, accessibility, cross-references

name: Documentation Validation

on:
  push:
    branches: [main, develop]
    paths:
      - 'docs/**'
      - 'apps/docs-*/**'
  pull_request:
    paths:
      - 'docs/**'
      - 'apps/docs-*/**'
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 0'  # Weekly on Sunday

jobs:
  validate-docs:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      {% if docs_site == 'sphinx-shibuya' %}
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install uv
        run: pip install uv

      - name: Install dependencies
        run: uv sync --group docs

      - name: Build documentation
        run: uv run make -f Makefile.docs docs

      - name: Link check with retry logic
        id: linkcheck
        continue-on-error: true
        run: |
          uv run make -f Makefile.docs linkcheck
          EXIT_CODE=$?
          
          # Parse link check results
          if [ -f "_build/linkcheck/output.txt" ]; then
            BROKEN_LINKS=$(grep -c "broken" _build/linkcheck/output.txt || echo "0")
            echo "broken_links=$BROKEN_LINKS" >> $GITHUB_OUTPUT
            
            if [ "$BROKEN_LINKS" -gt 0 ]; then
              echo "::warning::Found $BROKEN_LINKS broken links"
              cat _build/linkcheck/output.txt
            fi
          fi
          
          exit $EXIT_CODE

      {% elif docs_site == 'fumadocs' or docs_site == 'docusaurus' %}
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build documentation
        run: pnpm --filter docs-{{ docs_site }} build

      - name: Link check
        continue-on-error: true
        run: |
          # Install link checker
          pnpm add -D linkinator
          
          # Check links with retry
          pnpm exec linkinator {% if docs_site == 'fumadocs' %}apps/docs-fumadocs/out{% else %}apps/docs-docusaurus/build{% endif %} \
            --recurse \
            --retry \
            --retry-errors \
            --retry-errors-count 3 \
            --timeout 10000
      {% endif %}

      - name: Validate documentation config
        run: |
          python3 scripts/ci/validate_docs_config.py .
        continue-on-error: true

      - name: Accessibility scan (WCAG 2.1 AA)
        continue-on-error: true  # Non-blocking per spec clarification Q3
        run: |
          # Install axe-core CLI
          npm install -g @axe-core/cli
          
          # Start local server
          {% if docs_site == 'sphinx-shibuya' %}
          python3 -m http.server 8000 --directory _build/html &
          {% elif docs_site == 'fumadocs' %}
          npx serve apps/docs-fumadocs/out -p 8000 &
          {% else %}
          npx serve apps/docs-docusaurus/build -p 8000 &
          {% endif %}
          SERVER_PID=$!
          
          # Wait for server
          sleep 5
          
          # Run accessibility scan
          axe http://localhost:8000 \
            --rules wcag21aa \
            --save accessibility-report.json || true
          
          # Kill server
          kill $SERVER_PID || true
          
          # Display results
          if [ -f "accessibility-report.json" ]; then
            echo "::group::Accessibility Report"
            cat accessibility-report.json | python3 -m json.tool
            echo "::endgroup::"
            
            # Count violations (warnings only, non-blocking)
            VIOLATIONS=$(cat accessibility-report.json | python3 -c "import sys, json; print(len(json.load(sys.stdin).get('violations', [])))" 2>/dev/null || echo "0")
            if [ "$VIOLATIONS" -gt 0 ]; then
              echo "::warning::Found $VIOLATIONS accessibility issues (WCAG 2.1 AA)"
            fi
          fi

      - name: Upload validation artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: validation-reports
          path: |
            {% if docs_site == 'sphinx-shibuya' %}_build/linkcheck/{% endif %}
            accessibility-report.json
          retention-days: 30

      - name: Generate validation summary
        if: always()
        run: |
          echo "## Documentation Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Framework**: {{ docs_site }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Link Check**: {% raw %}${{ steps.linkcheck.outcome }}{% endraw %}" >> $GITHUB_STEP_SUMMARY
          {% if docs_site == 'sphinx-shibuya' %}
          if [ -f "_build/linkcheck/output.txt" ]; then
            echo "- **Broken Links**: {% raw %}${{ steps.linkcheck.outputs.broken_links || 0 }}{% endraw %}" >> $GITHUB_STEP_SUMMARY
          fi
          {% endif %}
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“Š Full reports available in workflow artifacts." >> $GITHUB_STEP_SUMMARY
{% endif %}
