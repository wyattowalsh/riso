{% if changelog_module == "enabled" -%}
# Semantic Release configuration for automated changelog and version management
# Generated by Riso template - Feature 014: Changelog & Release Management
# Docs: https://semantic-release.gitbook.io/

# Branches that trigger releases
branches:
  - main
  - name: beta
    prerelease: true
  - name: alpha
    prerelease: true

# Repository URL
repositoryUrl: "https://github.com/{{ project_slug | default('owner/repo') }}"

# Git tag format
{% if project_layout == "monorepo" %}
tagFormat: "${name}/v${version}"
{% else %}
tagFormat: "v${version}"
{% endif %}

# Release plugins
plugins:
  # Analyze commits to determine version bump
  - "@semantic-release/commit-analyzer"
    releaseRules:
      - type: feat
        release: minor
      - type: fix
        release: patch
      - type: perf
        release: patch
      - type: revert
        release: patch
      - type: docs
        release: false
      - type: chore
        release: false
      - type: refactor
        release: false
      - type: test
        release: false
      - type: ci
        release: false
      - type: build
        release: false

  # Generate release notes
  - - "@semantic-release/release-notes-generator"
    - preset: "angular"
      writerOpts:
        commitGroupsSort:
          - feat
          - fix
          - perf
          - revert
        commitSort: "subject"
        transform:
          feat: "? Features"
          fix: "?? Bug Fixes"
          perf: "? Performance Improvements"
          revert: "? Reverts"
          docs: "?? Documentation"
          chore: "?? Chores"
          refactor: "?? Code Refactoring"
          test: "? Tests"

  # Update CHANGELOG.md
  - - "@semantic-release/changelog"
    - changelogFile: "CHANGELOG.md"
      changelogTitle: "# Changelog\\n\\nAll notable changes to this project will be documented in this file.\\n\\nThe format is based on [Keep a Changelog](https://keepachangelog.com/en/1.0.0/),\\nand this project adheres to [Semantic Versioning](https://semver.org/spec/v2.0.0.html)."

  # Update version in project files
  - - "@semantic-release/exec"
    - verifyConditionsCmd: "echo 'Verifying release conditions'"
      prepareCmd: "uv run python scripts/release/update-version.py ${nextRelease.version}"
{% if api_tracks in ['node', 'python+node'] %}
      publishCmd: "uv run python scripts/release/publish-artifacts.py"
{% elif api_tracks == 'python' %}
      publishCmd: "uv run python scripts/release/publish-pypi.py"
{% endif %}

{% if api_tracks in ['node', 'python+node'] %}
  # Publish to npm registry (if Node track enabled)
  - - "@semantic-release/npm"
    - npmPublish: true
      pkgRoot: "."
{% endif %}

  # Commit changelog and version files
  - - "@semantic-release/git"
    - assets:
        - "CHANGELOG.md"
{% if api_tracks in ['python', 'python+node'] %}
        - "pyproject.toml"
{% endif %}
{% if api_tracks in ['node', 'python+node'] %}
        - "package.json"
{% endif %}
      message: "chore(release): ${nextRelease.version} [skip ci]\\n\\n${nextRelease.notes}"

  # Create GitHub Release
  - - "@semantic-release/github"
    - assets:
{% if api_tracks in ['python', 'python+node'] %}
        - path: "dist/*.whl"
          label: "Python Wheel"
        - path: "dist/*.tar.gz"
          label: "Source Distribution"
{% endif %}
{% if api_tracks in ['node', 'python+node'] %}
        - path: "*.tgz"
          label: "npm Package"
{% endif %}
      addReleases: "top"
      successComment: "?? This ${issue.pull_request ? 'PR is included' : 'issue has been resolved'} in version ${nextRelease.version}"
      labels:
        - "released"

# Preset for commit conventions
preset: "angular"

# CI mode
ci: true

# Dry run mode (set via environment variable DRY_RUN=true)
dryRun: false
{% endif %}
