{% if changelog_module == "enabled" -%}
#!/usr/bin/env python3
"""Update version numbers in project files.

This script updates version numbers in pyproject.toml and package.json files
during the release process. It's called by semantic-release via the @semantic-release/exec plugin.

Usage:
    python update-version.py <new-version>

Args:
    new-version: Semantic version string (e.g., "1.2.3")

Generated by Riso template - Feature 014: Changelog & Release Management
"""

import json
import re
import sys
from pathlib import Path
from typing import Optional


def update_pyproject_version(project_root: Path, new_version: str) -> bool:
    """Update version in pyproject.toml.
    
    Args:
        project_root: Project root directory
        new_version: New version string
        
    Returns:
        True if updated successfully, False otherwise
    """
    pyproject_path = project_root / 'pyproject.toml'
    
    if not pyproject_path.exists():
        print(f"??  pyproject.toml not found, skipping", file=sys.stderr)
        return True  # Not an error if file doesn't exist
    
    try:
        content = pyproject_path.read_text(encoding='utf-8')
        
        # Update version field
        pattern = r'^version\s*=\s*["\']([^"\']+)["\']'
        replacement = f'version = "{new_version}"'
        
        new_content, count = re.subn(
            pattern,
            replacement,
            content,
            count=1,
            flags=re.MULTILINE
        )
        
        if count == 0:
            print(f"??  Version field not found in pyproject.toml", file=sys.stderr)
            return False
        
        pyproject_path.write_text(new_content, encoding='utf-8')
        print(f"? Updated pyproject.toml: {new_version}")
        return True
        
    except Exception as e:
        print(f"? Error updating pyproject.toml: {e}", file=sys.stderr)
        return False


def update_package_json_version(project_root: Path, new_version: str) -> bool:
    """Update version in package.json.
    
    Args:
        project_root: Project root directory
        new_version: New version string
        
    Returns:
        True if updated successfully, False otherwise
    """
    package_json_path = project_root / 'package.json'
    
    if not package_json_path.exists():
        print(f"??  package.json not found, skipping", file=sys.stderr)
        return True  # Not an error if file doesn't exist
    
    try:
        with open(package_json_path, 'r', encoding='utf-8') as f:
            package_data = json.load(f)
        
        old_version = package_data.get('version', 'unknown')
        package_data['version'] = new_version
        
        with open(package_json_path, 'w', encoding='utf-8') as f:
            json.dump(package_data, f, indent=2, ensure_ascii=False)
            f.write('\n')  # Add trailing newline
        
        print(f"? Updated package.json: {old_version} ? {new_version}")
        return True
        
    except json.JSONDecodeError as e:
        print(f"? Error parsing package.json: {e}", file=sys.stderr)
        return False
    except Exception as e:
        print(f"? Error updating package.json: {e}", file=sys.stderr)
        return False


def validate_version_format(version: str) -> bool:
    """Validate semantic version format.
    
    Args:
        version: Version string to validate
        
    Returns:
        True if valid, False otherwise
    """
    # SemVer 2.0.0 pattern
    pattern = r'^(?P<major>0|[1-9]\d*)\.(?P<minor>0|[1-9]\d*)\.(?P<patch>0|[1-9]\d*)(?:-(?P<prerelease>(?:0|[1-9]\d*|\d*[a-zA-Z-][0-9a-zA-Z-]*)(?:\.(?:0|[1-9]\d*|\d*[a-zA-Z-][0-9a-zA-Z-]*))*))?(?:\+(?P<build>[0-9a-zA-Z-]+(?:\.[0-9a-zA-Z-]+)*))?$'
    
    return bool(re.match(pattern, version))


def find_project_root() -> Optional[Path]:
    """Find the project root directory.
    
    Returns:
        Path to project root, or None if not found
    """
    current = Path.cwd()
    
    # Look for project root indicators
    indicators = ['.git', 'pyproject.toml', 'package.json']
    
    while current != current.parent:
        if any((current / indicator).exists() for indicator in indicators):
            return current
        current = current.parent
    
    return None


def main() -> int:
    """Main entry point for version update script.
    
    Returns:
        Exit code: 0 for success, 1 for failure
    """
    if len(sys.argv) < 2:
        print("Usage: update-version.py <new-version>", file=sys.stderr)
        print("Example: update-version.py 1.2.3", file=sys.stderr)
        return 1
    
    new_version = sys.argv[1].lstrip('v')  # Remove 'v' prefix if present
    
    # Validate version format
    if not validate_version_format(new_version):
        print(f"? Invalid version format: {new_version}", file=sys.stderr)
        print("Expected format: MAJOR.MINOR.PATCH[-PRERELEASE][+BUILD]", file=sys.stderr)
        return 1
    
    # Find project root
    project_root = find_project_root()
    
    if project_root is None:
        print("? Could not find project root", file=sys.stderr)
        return 1
    
    print(f"?? Project root: {project_root}")
    print(f"?? Updating version to: {new_version}")
    print()
    
    # Update files
    success = True
    
{% if api_tracks in ['python', 'python+node'] %}
    # Update pyproject.toml
    if not update_pyproject_version(project_root, new_version):
        success = False
{% endif %}

{% if api_tracks in ['node', 'python+node'] %}
    # Update package.json
    if not update_package_json_version(project_root, new_version):
        success = False
{% endif %}

{% if api_tracks == 'none' %}
    # No API tracks configured, try updating both if they exist
    update_pyproject_version(project_root, new_version)
    update_package_json_version(project_root, new_version)
{% endif %}
    
    if success:
        print()
        print("? Version updated successfully!")
        return 0
    else:
        print()
        print("? Some version updates failed")
        return 1


if __name__ == "__main__":
    sys.exit(main())
{% endif %}
