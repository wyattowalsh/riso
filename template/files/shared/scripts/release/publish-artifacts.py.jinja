{% if changelog_module == "enabled" -%}
#!/usr/bin/env python3
"""Orchestrate artifact publishing to multiple registries.

This script coordinates publishing to PyPI, npm, and Docker Hub registries
in parallel when applicable.

Usage:
    python publish-artifacts.py [--dry-run]

Environment Variables:
    DRY_RUN: Set to 'true' to skip actual publishing
    PYPI_TOKEN: PyPI API token
    NPM_TOKEN: npm authentication token
    DOCKER_HUB_USERNAME: Docker Hub username
    DOCKER_HUB_TOKEN: Docker Hub access token

Generated by Riso template - Feature 014: Changelog & Release Management
"""

import os
import subprocess
import sys
from concurrent.futures import ThreadPoolExecutor, as_completed
from pathlib import Path
from typing import Optional


def run_publisher_script(script_name: str, dry_run: bool = False) -> tuple[str, bool, str]:
    """Run a publisher script.
    
    Args:
        script_name: Name of the script to run
        dry_run: Whether to run in dry-run mode
        
    Returns:
        Tuple of (script_name, success, output)
    """
    script_path = Path(__file__).parent / script_name
    
    if not script_path.exists():
        return (script_name, False, f"Script not found: {script_path}")
    
    try:
        cmd = ['python3', str(script_path)]
        if dry_run:
            cmd.append('--dry-run')
        
        print(f"?? Starting: {script_name}")
        
        result = subprocess.run(
            cmd,
            capture_output=True,
            text=True,
            check=False
        )
        
        output = result.stdout + result.stderr
        success = result.returncode == 0
        
        return (script_name, success, output)
        
    except Exception as e:
        return (script_name, False, str(e))


def main() -> int:
    """Main entry point for artifact publishing orchestration.
    
    Returns:
        Exit code: 0 for success, 1 for failure
    """
    dry_run = os.getenv('DRY_RUN', 'false').lower() == 'true' or '--dry-run' in sys.argv
    
    print("=" * 70)
    print("?? Artifact Publishing Orchestrator")
    print("=" * 70)
    print()
    
    if dry_run:
        print("?? DRY RUN MODE - No actual publishing will occur")
        print()
    
    # Determine which publishers to run
    publishers = []
    
{% if api_tracks in ['python', 'python+node'] %}
    # PyPI publishing
    if os.getenv('PYPI_TOKEN'):
        publishers.append('publish-pypi.py')
        print("? PyPI publishing enabled")
    else:
        print("??  PyPI publishing skipped (PYPI_TOKEN not set)")
{% endif %}

{% if api_tracks in ['node', 'python+node'] %}
    # npm publishing (handled by semantic-release/npm plugin)
    if os.getenv('NPM_TOKEN'):
        print("? npm publishing enabled (handled by semantic-release)")
    else:
        print("??  npm publishing skipped (NPM_TOKEN not set)")
{% endif %}
    
    # Docker Hub publishing (if enabled)
    if os.getenv('DOCKER_HUB_USERNAME') and os.getenv('DOCKER_HUB_TOKEN'):
        # Note: Docker publishing is typically handled by container workflows
        print("??  Docker Hub credentials configured")
    
    if not publishers:
        print()
        print("??  No publishers configured or credentials missing")
        print()
        print("To enable publishing, configure:")
{% if api_tracks in ['python', 'python+node'] %}
        print("  - PYPI_TOKEN for PyPI")
{% endif %}
{% if api_tracks in ['node', 'python+node'] %}
        print("  - NPM_TOKEN for npm")
{% endif %}
        print("  - DOCKER_HUB_USERNAME and DOCKER_HUB_TOKEN for Docker Hub")
        return 0  # Not a failure if no publishers configured
    
    print()
    print(f"?? Running {len(publishers)} publisher(s)...")
    print()
    
    # Run publishers in parallel
    results = []
    
    with ThreadPoolExecutor(max_workers=len(publishers)) as executor:
        futures = {
            executor.submit(run_publisher_script, publisher, dry_run): publisher
            for publisher in publishers
        }
        
        for future in as_completed(futures):
            publisher = futures[future]
            try:
                script_name, success, output = future.result()
                results.append((script_name, success, output))
                
                print("-" * 70)
                print(f"?? Output from {script_name}:")
                print("-" * 70)
                print(output)
                print()
                
            except Exception as e:
                print(f"? Exception in {publisher}: {e}", file=sys.stderr)
                results.append((publisher, False, str(e)))
    
    # Summary
    print("=" * 70)
    print("?? Publishing Summary")
    print("=" * 70)
    print()
    
    success_count = sum(1 for _, success, _ in results if success)
    failure_count = len(results) - success_count
    
    for script_name, success, _ in results:
        status = "? Success" if success else "? Failed"
        print(f"{status}: {script_name}")
    
    print()
    print(f"Total: {success_count} succeeded, {failure_count} failed")
    print()
    
    if failure_count > 0:
        print("? Some publishers failed")
        return 1
    
    print("? All publishers completed successfully!")
    return 0


if __name__ == "__main__":
    sys.exit(main())
{% endif %}
