"""
Markdown to MDX transformer.
Feature: 018-docs-sites-overhaul
Generated by Riso template for {{ project_name }}
"""

import re
from typing import Dict, List
from .common import (
    ContentFormat,
    ContentTransformationRule,
    TransformationFailureMode,
)


class MarkdownToMDXTransformer:
    """Transform Markdown content to MDX format for Fumadocs/Docusaurus."""

    def transform(self, content: str) -> str:
        """
        Transform Markdown to MDX.
        
        Most Markdown is valid MDX, so transformation is minimal.
        Main differences:
        - Preserve frontmatter
        - Convert admonitions to JSX components (if needed)
        - Ensure code blocks are properly formatted
        
        Args:
            content: Markdown content
            
        Returns:
            MDX-formatted content
        """
        # MDX is mostly compatible with Markdown
        # Main transformations:
        # 1. Preserve frontmatter (already Markdown compatible)
        # 2. Convert custom admonitions if using specific syntax
        # 3. Ensure JSX components are properly formatted
        
        lines = content.split('\n')
        mdx_lines = []
        
        for line in lines:
            # Transform admonitions if using blockquote syntax
            if line.strip().startswith('> **Note'):
                mdx_lines.append(self._transform_note_admonition(line))
            elif line.strip().startswith('> **Warning'):
                mdx_lines.append(self._transform_warning_admonition(line))
            else:
                mdx_lines.append(line)
        
        return '\n'.join(mdx_lines)

    def _transform_note_admonition(self, line: str) -> str:
        """Transform note admonition to MDX component."""
        content = line.strip().lstrip('> **Note:**').strip()
        return f'<Callout type="note">{content}</Callout>'

    def _transform_warning_admonition(self, line: str) -> str:
        """Transform warning admonition to MDX component."""
        content = line.strip().lstrip('> **Warning:**').strip()
        return f'<Callout type="warning">{content}</Callout>'


def create_markdown_to_mdx_rule() -> ContentTransformationRule:
    """Create a Markdown to MDX transformation rule."""
    transformer = MarkdownToMDXTransformer()
    
    return ContentTransformationRule(
        source_format=ContentFormat.MARKDOWN,
        target_format=ContentFormat.MDX,
        transformation_fn=transformer.transform,
        supported_extensions=["mermaid", "jsx-components"],
        failure_mode=TransformationFailureMode.WARN  # MDX is mostly Markdown-compatible
    )
