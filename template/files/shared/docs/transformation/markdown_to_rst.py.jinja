"""
Markdown to reStructuredText (RST) transformer.
Feature: 018-docs-sites-overhaul
Generated by Riso template for {{ project_name }}
"""

import re
from typing import Dict, List, Tuple
from .common import (
    ContentFormat,
    ContentTransformationRule,
    TransformationFailureMode,
    TransformationResult,
    TransformationError,
)


class MarkdownToRSTTransformer:
    """Transform Markdown content to reStructuredText format for Sphinx."""

    def __init__(self):
        self.in_code_block = False
        self.code_block_lang = ""

    def transform(self, content: str) -> str:
        """
        Transform Markdown to RST.
        
        Args:
            content: Markdown content
            
        Returns:
            RST-formatted content
        """
        lines = content.split('\n')
        rst_lines = []
        i = 0

        while i < len(lines):
            line = lines[i]
            
            # Handle code blocks
            if line.strip().startswith('```'):
                code_block, lines_consumed = self._transform_code_block(lines[i:])
                rst_lines.extend(code_block)
                i += lines_consumed
                continue
            
            # Handle Mermaid diagrams (FR-008, T040)
            if line.strip().startswith('```mermaid'):
                mermaid_block, lines_consumed = self._transform_mermaid(lines[i:])
                rst_lines.extend(mermaid_block)
                i += lines_consumed
                continue
            
            # Handle headings (T044)
            if line.startswith('#'):
                rst_lines.append(self._transform_heading(line))
                i += 1
                continue
            
            # Handle admonitions (T041)
            if line.strip().startswith(':::') or line.strip().startswith('> **'):
                admonition, lines_consumed = self._transform_admonition(lines[i:])
                rst_lines.extend(admonition)
                i += lines_consumed
                continue
            
            # Handle links (T043)
            line = self._transform_links(line)
            
            # Handle inline code, bold, italic
            line = self._transform_inline_formatting(line)
            
            rst_lines.append(line)
            i += 1

        return '\n'.join(rst_lines)

    def _transform_heading(self, line: str) -> str:
        """Transform Markdown heading to RST."""
        level = len(line) - len(line.lstrip('#'))
        text = line.lstrip('#').strip()
        
        # RST heading underlines: = - ` : . ' " ~
        underline_chars = ['=', '-', '`', ':', '.', "'", '"', '~']
        underline = underline_chars[min(level - 1, len(underline_chars) - 1)] * len(text)
        
        return f"{text}\n{underline}"

    def _transform_code_block(self, lines: List[str]) -> Tuple[List[str], int]:
        """Transform Markdown code block to RST code-block directive (T042)."""
        rst_lines = []
        first_line = lines[0].strip()
        
        # Extract language
        lang = first_line[3:].strip() if len(first_line) > 3 else 'text'
        
        rst_lines.append(f".. code-block:: {lang}")
        rst_lines.append("")
        
        i = 1
        while i < len(lines) and not lines[i].strip().startswith('```'):
            rst_lines.append(f"   {lines[i]}")
            i += 1
        
        rst_lines.append("")
        return rst_lines, i + 1

    def _transform_mermaid(self, lines: List[str]) -> Tuple[List[str], int]:
        """Transform Mermaid code block to RST mermaid directive (FR-008, T040)."""
        rst_lines = [".. mermaid::", ""]
        
        i = 1
        while i < len(lines) and not lines[i].strip().startswith('```'):
            rst_lines.append(f"   {lines[i]}")
            i += 1
        
        rst_lines.append("")
        return rst_lines, i + 1

    def _transform_admonition(self, lines: List[str]) -> Tuple[List[str], int]:
        """Transform Markdown admonition to RST directive (T041)."""
        first_line = lines[0].strip()
        
        # Detect admonition type
        admonition_type = "note"
        if "warning" in first_line.lower():
            admonition_type = "warning"
        elif "danger" in first_line.lower() or "error" in first_line.lower():
            admonition_type = "danger"
        elif "tip" in first_line.lower():
            admonition_type = "tip"
        elif "important" in first_line.lower():
            admonition_type = "important"
        
        rst_lines = [f".. {admonition_type}::", ""]
        
        i = 1
        while i < len(lines) and lines[i].strip():
            content = lines[i].lstrip('> ').strip()
            rst_lines.append(f"   {content}")
            i += 1
        
        rst_lines.append("")
        return rst_lines, i

    def _transform_links(self, line: str) -> str:
        """Transform Markdown links to RST (T043)."""
        # [text](url) -> `text <url>`_
        line = re.sub(
            r'\[([^\]]+)\]\(([^\)]+)\)',
            r'`\1 <\2>`_',
            line
        )
        return line

    def _transform_inline_formatting(self, line: str) -> str:
        """Transform inline formatting (bold, italic, code)."""
        # **bold** -> **bold** (same in RST)
        # *italic* -> *italic* (same in RST)
        # `code` -> ``code``
        line = re.sub(r'`([^`]+)`', r'``\1``', line)
        return line


def create_markdown_to_rst_rule() -> ContentTransformationRule:
    """Create a Markdown to RST transformation rule."""
    transformer = MarkdownToRSTTransformer()
    
    return ContentTransformationRule(
        source_format=ContentFormat.MARKDOWN,
        target_format=ContentFormat.RST,
        transformation_fn=transformer.transform,
        supported_extensions=["mermaid", "admonitions", "code-blocks"],
        failure_mode=TransformationFailureMode.ERROR
    )
