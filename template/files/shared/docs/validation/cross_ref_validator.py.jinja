"""
Cross-reference validator for Sphinx documentation.
Feature: 018-docs-sites-overhaul
Generated by Riso template for {{ project_name }}
"""

from pathlib import Path
from typing import List
import re


class CrossRefValidator:
    """Validate Sphinx cross-references (:doc: and :ref:)."""

    def __init__(self, docs_dir: Path):
        self.docs_dir = docs_dir
        self.invalid_refs: List[str] = []

    def validate(self) -> List[str]:
        """
        Validate all cross-references.
        
        Returns:
            List of invalid cross-references
        """
        # Find all RST files
        rst_files = list(self.docs_dir.rglob('*.rst'))
        
        for rst_file in rst_files:
            content = rst_file.read_text(errors='ignore')
            
            # Check :doc: references
            doc_refs = self._extract_doc_refs(content)
            for ref in doc_refs:
                if not self._doc_exists(rst_file.parent, ref):
                    self.invalid_refs.append(f"{rst_file}::doc:`{ref}`")
            
            # Check :ref: references (labels)
            ref_refs = self._extract_ref_refs(content)
            # Note: Validating :ref: requires parsing all RST files for labels
            # This is a simplified implementation
        
        return self.invalid_refs

    def _extract_doc_refs(self, content: str) -> List[str]:
        """Extract :doc: references from RST content."""
        pattern = r':doc:`([^`]+)`'
        return re.findall(pattern, content)

    def _extract_ref_refs(self, content: str) -> List[str]:
        """Extract :ref: references from RST content."""
        pattern = r':ref:`([^`]+)`'
        return re.findall(pattern, content)

    def _doc_exists(self, current_dir: Path, doc_ref: str) -> bool:
        """Check if :doc: target exists."""
        # Remove any label anchors
        doc_ref = doc_ref.split('#')[0].strip()
        
        # Resolve relative path
        if doc_ref.startswith('/'):
            target = self.docs_dir / doc_ref.lstrip('/').replace('/', '/') / 'index.rst'
        else:
            target = current_dir / doc_ref.replace('/', '/')
        
        # Try with .rst extension
        if not target.suffix:
            target = target.with_suffix('.rst')
        
        return target.exists() or (target.parent / 'index.rst').exists()
