"""
Image reference validator for documentation.
Feature: 018-docs-sites-overhaul
Generated by Riso template for {{ project_name }}
"""

from pathlib import Path
from typing import List
import re


class ImageValidator:
    """Validate image references in documentation."""

    def __init__(self, docs_dir: Path):
        self.docs_dir = docs_dir
        self.missing_images: List[str] = []

    def validate(self) -> List[str]:
        """
        Validate all image references.
        
        Returns:
            List of missing image paths
        """
        # Find all documentation files
        doc_files = []
        for ext in ['*.md', '*.rst', '*.mdx']:
            doc_files.extend(self.docs_dir.rglob(ext))
        
        for doc_file in doc_files:
            content = doc_file.read_text(errors='ignore')
            images = self._extract_images(content)
            
            for img_path in images:
                if not self._image_exists(doc_file.parent, img_path):
                    self.missing_images.append(f"{doc_file}:{img_path}")
        
        return self.missing_images

    def _extract_images(self, content: str) -> List[str]:
        """Extract image references from documentation content."""
        images = []
        
        # Markdown: ![alt](path)
        md_pattern = r'!\[[^\]]*\]\(([^\)]+)\)'
        images.extend(re.findall(md_pattern, content))
        
        # RST: .. image:: path
        rst_pattern = r'\.\. image:: (.+)'
        images.extend(re.findall(rst_pattern, content))
        
        # HTML: <img src="path">
        html_pattern = r'<img[^>]+src=["\']([^"\']+)["\']'
        images.extend(re.findall(html_pattern, content))
        
        return images

    def _image_exists(self, doc_dir: Path, img_path: str) -> bool:
        """Check if image file exists."""
        # Skip external URLs
        if img_path.startswith('http://') or img_path.startswith('https://'):
            return True
        
        # Resolve relative path
        if img_path.startswith('/'):
            full_path = self.docs_dir / img_path.lstrip('/')
        else:
            full_path = (doc_dir / img_path).resolve()
        
        return full_path.exists()
