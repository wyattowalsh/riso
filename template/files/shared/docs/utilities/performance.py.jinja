"""
Documentation build performance monitoring utilities.
Feature: 018-docs-sites-overhaul
Generated by Riso template for {{ project_name }}
"""

import time
from dataclasses import dataclass
from pathlib import Path
from typing import Dict, List, Optional


@dataclass
class BuildMetrics:
    """Build performance metrics."""
    
    framework: str
    start_time: float
    end_time: float
    duration: float
    pages_built: int
    artifact_size_mb: float
    cache_hit: bool
    warnings: int
    errors: int

    @property
    def duration_seconds(self) -> float:
        """Get duration in seconds."""
        return self.duration

    @property
    def pages_per_second(self) -> float:
        """Calculate build speed."""
        if self.duration == 0:
            return 0
        return self.pages_built / self.duration

    def is_within_target(self, target_seconds: float = 90) -> bool:
        """
        Check if build is within target time.
        
        Args:
            target_seconds: Target build time in seconds (default: 90s per spec)
            
        Returns:
            True if build completed within target
        """
        return self.duration <= target_seconds

    def format_report(self) -> str:
        """Generate human-readable report."""
        status = "✅ PASS" if self.is_within_target() else "⚠️ SLOW"
        
        return f"""
Build Performance Report
========================
Framework: {self.framework}
Status: {status}
Duration: {self.duration:.2f}s (target: 90s)
Pages Built: {self.pages_built}
Build Speed: {self.pages_per_second:.2f} pages/sec
Artifact Size: {self.artifact_size_mb:.2f}MB
Cache Hit: {'Yes' if self.cache_hit else 'No'}
Warnings: {self.warnings}
Errors: {self.errors}
"""


class BuildMonitor:
    """Monitor documentation build performance."""

    def __init__(self, framework: str):
        self.framework = framework
        self.start_time: Optional[float] = None
        self.end_time: Optional[float] = None
        self.pages_built = 0
        self.warnings = 0
        self.errors = 0
        self.cache_hit = False

    def start(self):
        """Start monitoring."""
        self.start_time = time.time()

    def stop(self) -> BuildMetrics:
        """
        Stop monitoring and return metrics.
        
        Returns:
            BuildMetrics object
        """
        self.end_time = time.time()
        duration = self.end_time - (self.start_time or self.end_time)
        
        return BuildMetrics(
            framework=self.framework,
            start_time=self.start_time or 0,
            end_time=self.end_time,
            duration=duration,
            pages_built=self.pages_built,
            artifact_size_mb=self._calculate_artifact_size(),
            cache_hit=self.cache_hit,
            warnings=self.warnings,
            errors=self.errors
        )

    def _calculate_artifact_size(self) -> float:
        """Calculate artifact size in MB."""
        # Placeholder - would calculate actual artifact size
        return 0.0


class PerformanceAnalyzer:
    """Analyze documentation build performance over time."""

    def __init__(self):
        self.metrics_history: List[BuildMetrics] = []

    def add_metrics(self, metrics: BuildMetrics):
        """Add metrics to history."""
        self.metrics_history.append(metrics)

    def get_average_duration(self) -> float:
        """Get average build duration."""
        if not self.metrics_history:
            return 0.0
        return sum(m.duration for m in self.metrics_history) / len(self.metrics_history)

    def get_slowest_build(self) -> Optional[BuildMetrics]:
        """Get slowest build metrics."""
        if not self.metrics_history:
            return None
        return max(self.metrics_history, key=lambda m: m.duration)

    def get_fastest_build(self) -> Optional[BuildMetrics]:
        """Get fastest build metrics."""
        if not self.metrics_history:
            return None
        return min(self.metrics_history, key=lambda m: m.duration)

    def generate_trend_report(self) -> str:
        """Generate trend analysis report."""
        if not self.metrics_history:
            return "No metrics available"
        
        avg_duration = self.get_average_duration()
        slowest = self.get_slowest_build()
        fastest = self.get_fastest_build()
        
        return f"""
Performance Trend Analysis
=========================
Total Builds: {len(self.metrics_history)}
Average Duration: {avg_duration:.2f}s
Fastest Build: {fastest.duration:.2f}s ({fastest.framework})
Slowest Build: {slowest.duration:.2f}s ({slowest.framework})
Target Compliance: {sum(1 for m in self.metrics_history if m.is_within_target())} / {len(self.metrics_history)} builds
"""
