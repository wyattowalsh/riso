"""
Version detection utility for documentation.
Feature: 018-docs-sites-overhaul
Generated by Riso template for {{ project_name }}
"""

import json
import os
from pathlib import Path
from typing import Dict, List, Optional


class VersionDetector:
    """Detect and manage documentation versions."""

    def __init__(self, versions_file: Optional[Path] = None):
        self.versions_file = versions_file or Path("docs/versioning/versions.json")

    def get_current_version(self) -> str:
        """Get the current documentation version."""
        # Try to read from environment
        version = os.getenv("DOCS_VERSION", "latest")
        
        # Try to read from git tag
        try:
            import subprocess
            result = subprocess.run(
                ["git", "describe", "--tags", "--abbrev=0"],
                capture_output=True,
                text=True,
                check=False
            )
            if result.returncode == 0:
                version = result.stdout.strip()
        except Exception:
            pass
        
        return version

    def get_available_versions(self) -> List[Dict[str, str]]:
        """Get list of available documentation versions."""
        if not self.versions_file.exists():
            return [{"name": "latest", "title": "Latest", "default": True}]
        
        try:
            with open(self.versions_file) as f:
                data = json.load(f)
                return data.get("versions", [])
        except Exception:
            return [{"name": "latest", "title": "Latest", "default": True}]

    def get_default_version(self) -> str:
        """Get the default version."""
        versions = self.get_available_versions()
        for version in versions:
            if version.get("default"):
                return version["name"]
        return "latest"

    def add_version(self, name: str, title: Optional[str] = None, aliases: Optional[List[str]] = None) -> None:
        """Add a new version to versions.json."""
        versions = self.get_available_versions()
        
        # Remove default flag from existing versions
        for version in versions:
            version["default"] = False
        
        # Add new version
        versions.insert(0, {
            "name": "name",
            "title": title or name,
            "aliases": aliases or [],
            "default": True
        })
        
        # Save
        self.versions_file.parent.mkdir(parents=True, exist_ok=True)
        with open(self.versions_file, 'w') as f:
            json.dump({"versions": versions}, f, indent=2)
