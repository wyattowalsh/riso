{% if changelog_module == "enabled" -%}
"""Changelog generation utilities.

This module provides functions for generating human-readable changelogs from
commit history, categorizing changes, and formatting markdown output.

Generated by Riso template - Feature 014: Changelog & Release Management
"""

import re
from datetime import date
from pathlib import Path
from typing import Optional
from . import Version
from .models import Change, ChangelogEntry, ChangelogSection, CommitType


def extract_pr_number(commit_message: str) -> Optional[int]:
    """Extract pull request number from commit message.
    
    Args:
        commit_message: Commit message text
        
    Returns:
        PR number if found, None otherwise
        
    Example:
        >>> extract_pr_number("feat: add feature (#123)")
        123
    """
    # Pattern: (#123) or GH-123 or github.com/.../pull/123
    patterns = [
        r'\(#(\d+)\)',
        r'GH-(\d+)',
        r'github\.com/.+/pull/(\d+)',
    ]
    
    for pattern in patterns:
        match = re.search(pattern, commit_message)
        if match:
            return int(match.group(1))
    
    return None


def generate_github_url(repo_url: str, commit_sha: str) -> str:
    """Generate GitHub commit URL.
    
    Args:
        repo_url: Repository URL (e.g., https://github.com/owner/repo)
        commit_sha: Commit SHA
        
    Returns:
        Full GitHub commit URL
    """
    repo_url = repo_url.rstrip('/')
    if repo_url.endswith('.git'):
        repo_url = repo_url[:-4]
    
    return f"{repo_url}/commit/{commit_sha}"


def generate_pr_url(repo_url: str, pr_number: int) -> str:
    """Generate GitHub pull request URL.
    
    Args:
        repo_url: Repository URL
        pr_number: PR number
        
    Returns:
        Full GitHub PR URL
    """
    repo_url = repo_url.rstrip('/')
    if repo_url.endswith('.git'):
        repo_url = repo_url[:-4]
    
    return f"{repo_url}/pull/{pr_number}"


def categorize_change(change: Change) -> ChangelogSection:
    """Categorize a change into a changelog section.
    
    Args:
        change: Change object
        
    Returns:
        Appropriate changelog section
    """
    if change.breaking:
        return ChangelogSection.BREAKING
    
    if change.type == CommitType.FEAT:
        return ChangelogSection.FEATURES
    elif change.type == CommitType.FIX:
        return ChangelogSection.BUG_FIXES
    elif change.type == CommitType.PERF:
        return ChangelogSection.PERFORMANCE
    elif change.type == CommitType.DOCS:
        return ChangelogSection.DOCUMENTATION
    elif change.type == CommitType.REVERT:
        return ChangelogSection.REVERTS
    
    # Default to features for other types
    return ChangelogSection.FEATURES


def format_change_markdown(change: Change, repo_url: str) -> str:
    """Format a change as markdown.
    
    Args:
        change: Change object
        repo_url: Repository URL for generating links
        
    Returns:
        Markdown formatted change
        
    Example:
        - **api**: add user authentication (#123) ([abc1234](https://github.com/owner/repo/commit/abc1234...))
    """
    parts = []
    
    # Scope
    if change.scope:
        parts.append(f"**{change.scope}**: ")
    else:
        parts.append("- ")
    
    # Subject
    parts.append(change.subject)
    
    # PR link
    if change.pr_number:
        pr_url = generate_pr_url(repo_url, change.pr_number)
        parts.append(f" ([#{change.pr_number}]({pr_url}))")
    
    # Commit link
    commit_url = generate_github_url(repo_url, change.commit_sha)
    parts.append(f" ([{change.commit_short_sha}]({commit_url}))")
    
    result = ''.join(parts)
    
    # Add migration notes for breaking changes
    if change.breaking and change.migration_notes:
        result += f"\n  - **Migration**: {change.migration_notes}"
    
    return result


def generate_changelog_markdown(entry: ChangelogEntry, repo_url: str) -> str:
    """Generate markdown for a changelog entry.
    
    Args:
        entry: Changelog entry
        repo_url: Repository URL for generating links
        
    Returns:
        Markdown formatted changelog
    """
    lines = []
    
    # Version header
    lines.append(f"## [{entry.version}] - {entry.release_date.isoformat()}")
    lines.append("")
    
    # Breaking changes (always first)
    if entry.breaking_changes:
        lines.append(f"### {ChangelogSection.BREAKING.value}")
        lines.append("")
        for change in entry.breaking_changes:
            lines.append(format_change_markdown(change, repo_url))
        lines.append("")
    
    # Features
    if entry.features:
        lines.append(f"### {ChangelogSection.FEATURES.value}")
        lines.append("")
        for change in entry.features:
            lines.append(format_change_markdown(change, repo_url))
        lines.append("")
    
    # Bug fixes
    if entry.bug_fixes:
        lines.append(f"### {ChangelogSection.BUG_FIXES.value}")
        lines.append("")
        for change in entry.bug_fixes:
            lines.append(format_change_markdown(change, repo_url))
        lines.append("")
    
    # Performance
    if entry.performance:
        lines.append(f"### {ChangelogSection.PERFORMANCE.value}")
        lines.append("")
        for change in entry.performance:
            lines.append(format_change_markdown(change, repo_url))
        lines.append("")
    
    # Documentation
    if entry.documentation:
        lines.append(f"### {ChangelogSection.DOCUMENTATION.value}")
        lines.append("")
        for change in entry.documentation:
            lines.append(format_change_markdown(change, repo_url))
        lines.append("")
    
    # Reverts
    if entry.reverts:
        lines.append(f"### {ChangelogSection.REVERTS.value}")
        lines.append("")
        for change in entry.reverts:
            lines.append(format_change_markdown(change, repo_url))
        lines.append("")
    
    return '\n'.join(lines)


def prepend_to_changelog(
    changelog_path: Path,
    new_entry: str,
    create_if_missing: bool = True
) -> None:
    """Prepend a new entry to the changelog file.
    
    Args:
        changelog_path: Path to CHANGELOG.md
        new_entry: New changelog entry markdown
        create_if_missing: Create file if it doesn't exist
    """
    if not changelog_path.exists():
        if create_if_missing:
            # Create new changelog with header
            header = """# Changelog

All notable changes to this project will be documented in this file.

The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.0.0/),
and this project adheres to [Semantic Versioning](https://semver.org/spec/v2.0.0.html).

"""
            content = header + new_entry + "\n"
            changelog_path.write_text(content, encoding='utf-8')
        return
    
    # Read existing content
    existing = changelog_path.read_text(encoding='utf-8')
    
    # Find insertion point (after header)
    lines = existing.split('\n')
    header_end = 0
    
    for i, line in enumerate(lines):
        if line.startswith('## ['):
            header_end = i
            break
    
    # Insert new entry
    if header_end > 0:
        new_content = '\n'.join(lines[:header_end]) + '\n' + new_entry + '\n' + '\n'.join(lines[header_end:])
    else:
        # No existing entries, append after header
        new_content = existing.rstrip() + '\n\n' + new_entry + '\n'
    
    changelog_path.write_text(new_content, encoding='utf-8')


__all__ = [
    "extract_pr_number",
    "generate_github_url",
    "generate_pr_url",
    "categorize_change",
    "format_change_markdown",
    "generate_changelog_markdown",
    "prepend_to_changelog",
]
{% endif %}
