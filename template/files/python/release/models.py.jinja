{% if changelog_module == "enabled" -%}
"""Data models for release management.

This module defines Pydantic models for commit messages, changelog entries,
versions, and other release-related entities.

Generated by Riso template - Feature 014: Changelog & Release Management
"""

from datetime import date
from enum import Enum
from typing import Optional
from pydantic import BaseModel, Field, field_validator


class CommitType(str, Enum):
    """Conventional commit types."""
    
    FEAT = "feat"
    FIX = "fix"
    DOCS = "docs"
    CHORE = "chore"
    REFACTOR = "refactor"
    TEST = "test"
    PERF = "perf"
    CI = "ci"
    BUILD = "build"
    REVERT = "revert"


class CommitMessage(BaseModel):
    """Parsed conventional commit message.
    
    Attributes:
        type: Commit type (feat, fix, etc.)
        scope: Optional scope (api, cli, etc.)
        subject: Short description
        body: Optional detailed description
        footer: Optional footer with metadata
        breaking: Whether this is a breaking change
        breaking_change_description: Description of breaking change
    """
    
    type: CommitType
    scope: Optional[str] = None
    subject: str = Field(..., max_length=72)
    body: Optional[str] = None
    footer: Optional[str] = None
    breaking: bool = False
    breaking_change_description: Optional[str] = None
    
    @field_validator('subject')
    @classmethod
    def validate_subject(cls, v: str) -> str:
        """Validate subject line format."""
        if v.endswith('.'):
            raise ValueError("Subject must not end with a period")
        if v and v[0].isupper():
            raise ValueError("Subject must start with lowercase")
        return v
    
    @field_validator('scope')
    @classmethod
    def validate_scope(cls, v: Optional[str]) -> Optional[str]:
        """Validate scope format."""
        if v is not None:
            if not v.replace('-', '').replace('_', '').isalnum():
                raise ValueError("Scope must contain only alphanumeric characters and hyphens")
        return v


class Change(BaseModel):
    """Individual change entry in a changelog.
    
    Attributes:
        type: Commit type
        scope: Optional scope
        subject: Change description
        commit_sha: Full commit SHA
        commit_short_sha: Short commit SHA (7 chars)
        commit_url: GitHub commit URL
        pr_number: Optional PR number
        pr_url: Optional PR URL
        breaking: Whether this is a breaking change
        migration_notes: Optional migration instructions
    """
    
    type: CommitType
    scope: Optional[str] = None
    subject: str
    commit_sha: str = Field(..., min_length=40, max_length=40)
    commit_short_sha: str = Field(..., min_length=7, max_length=7)
    commit_url: str
    pr_number: Optional[int] = None
    pr_url: Optional[str] = None
    breaking: bool = False
    migration_notes: Optional[str] = None


class ChangelogSection(str, Enum):
    """Changelog section categories."""
    
    BREAKING = "?? BREAKING CHANGES"
    FEATURES = "? Features"
    BUG_FIXES = "?? Bug Fixes"
    PERFORMANCE = "? Performance Improvements"
    DOCUMENTATION = "?? Documentation"
    REVERTS = "? Reverts"


class ChangelogEntry(BaseModel):
    """Changelog entry for a specific version.
    
    Attributes:
        version: Semantic version
        release_date: Date of release
        breaking_changes: Breaking changes
        features: New features
        bug_fixes: Bug fixes
        performance: Performance improvements
        documentation: Documentation updates
        reverts: Reverted commits
    """
    
    version: str = Field(..., pattern=r'^\d+\.\d+\.\d+(-[a-zA-Z0-9.-]+)?(\+[a-zA-Z0-9.-]+)?$')
    release_date: date
    breaking_changes: list[Change] = Field(default_factory=list)
    features: list[Change] = Field(default_factory=list)
    bug_fixes: list[Change] = Field(default_factory=list)
    performance: list[Change] = Field(default_factory=list)
    documentation: list[Change] = Field(default_factory=list)
    reverts: list[Change] = Field(default_factory=list)
    
    @property
    def has_changes(self) -> bool:
        """Check if entry has any changes."""
        return bool(
            self.breaking_changes or
            self.features or
            self.bug_fixes or
            self.performance or
            self.documentation or
            self.reverts
        )
    
    @property
    def change_count(self) -> int:
        """Count total number of changes."""
        return (
            len(self.breaking_changes) +
            len(self.features) +
            len(self.bug_fixes) +
            len(self.performance) +
            len(self.documentation) +
            len(self.reverts)
        )


class ReleaseConfiguration(BaseModel):
    """Configuration for release automation.
    
    Attributes:
        branches: Branches that trigger releases
        repository_url: GitHub repository URL
        tag_format: Git tag format template
        changelog_file: Path to changelog file
        monorepo: Whether this is a monorepo project
    """
    
    branches: list[str] = Field(default_factory=lambda: ["main"])
    repository_url: str
    tag_format: str = "v${version}"
    changelog_file: str = "CHANGELOG.md"
    monorepo: bool = False
    
    @field_validator('repository_url')
    @classmethod
    def validate_repository_url(cls, v: str) -> str:
        """Validate GitHub repository URL format."""
        if not v.startswith('https://github.com/'):
            raise ValueError("Repository URL must be a GitHub URL")
        return v


class VersionBump(str, Enum):
    """Types of version bumps."""
    
    MAJOR = "major"
    MINOR = "minor"
    PATCH = "patch"
    NONE = "none"


__all__ = [
    "CommitType",
    "CommitMessage",
    "Change",
    "ChangelogSection",
    "ChangelogEntry",
    "ReleaseConfiguration",
    "VersionBump",
]
{% endif %}
