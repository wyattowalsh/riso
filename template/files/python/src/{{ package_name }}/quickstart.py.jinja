"""Baseline quickstart workflow executed after rendering the template."""

from __future__ import annotations

import json
import subprocess
from dataclasses import dataclass
from pathlib import Path

COMMANDS: list[list[str]] = [
    ["uv", "sync", "--group", "quality", "--group", "test"],
    ["make", "quality"],
    [
        "uv",
        "run",
        "--group",
        "quality",
        "--group",
        "test",
        "task",
        "quality",
    ],
]


@dataclass
class QuickstartResult:
    """Captured execution metadata for the quickstart workflow."""

    status: str
    commands: list[list[str]]
    executed: int

    def as_dict(self) -> dict[str, object]:
        """Return a JSON-serialisable representation of the result."""
        return {
            "status": self.status,
            "commands": [list(cmd) for cmd in self.commands],
            "executed": self.executed,
        }


def _run_commands(commands: list[list[str]]) -> int:
    """Execute each command sequentially, returning the number executed."""
    executed = 0
    for cmd in commands:
        subprocess.run(cmd, check=True, shell=False)  # noqa: S603
        executed += 1
    return executed


def run_quickstart(*, dry_run: bool = False) -> dict[str, object]:
    """Execute (or simulate) the baseline quickstart sequence."""
    executed = 0
    if not dry_run:
        executed = _run_commands(COMMANDS)
    result = QuickstartResult(status="ok", commands=COMMANDS, executed=executed)
    return result.as_dict()


def write_evidence(destination: Path, payload: dict[str, object]) -> None:
    """Persist quickstart evidence to ``destination`` as formatted JSON."""
    destination.parent.mkdir(parents=True, exist_ok=True)
    destination.write_text(json.dumps(payload, indent=2), encoding="utf-8")


if __name__ == "__main__":
    data = run_quickstart(dry_run=False)
    evidence_file = Path("samples") / "default" / "quickstart.log"
    write_evidence(evidence_file, data)
