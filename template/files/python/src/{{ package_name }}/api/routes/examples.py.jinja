{%- if api_tracks | lower not in ["python", "python+node"] %}
"""Example routes disabled for this render."""
{%- else %}
"""Example CRUD endpoints demonstrating FastAPI patterns.

This module provides example endpoints showing how to:
- List resources with pagination
- Create new resources with validation
- Retrieve individual resources
- Update existing resources
- Delete resources
- Handle errors and validation failures

These examples use in-memory storage for demonstration.
In a real application, replace with database operations.
"""

from __future__ import annotations

import uuid
from datetime import UTC, datetime
from typing import Annotated

from fastapi import APIRouter, HTTPException, Path, Query, status

from ..models.requests import ExampleCreateRequest, ExampleUpdateRequest
from ..models.responses import ExampleResponse

router = APIRouter(prefix="/examples", tags=["Examples"])

# In-memory storage for demonstration
# In a real application, use a database
_examples_db: dict[str, dict] = {}


@router.get(
    "/",
    response_model=list[ExampleResponse],
    status_code=status.HTTP_200_OK,
    summary="List Examples",
    description="Retrieve all examples with optional pagination",
)
async def list_examples(
    limit: Annotated[int, Query(ge=1, le=100, description="Maximum results")] = 10,
    offset: Annotated[int, Query(ge=0, description="Number of results to skip")] = 0,
) -> list[ExampleResponse]:
    """List all examples with pagination.

    Args:
        limit: Maximum number of results to return (1-100)
        offset: Number of results to skip for pagination

    Returns:
        list[ExampleResponse]: List of example resources

    Example:
        GET /examples/?limit=10&offset=0
        Response: [
            {
                "id": "550e8400-e29b-41d4-a716-446655440000",
                "name": "Example 1",
                "value": 42,
                "tags": ["demo"],
                "created_at": "2025-11-01T12:00:00Z",
                "updated_at": "2025-11-01T12:00:00Z"
            }
        ]
    """
    all_examples = list(_examples_db.values())
    paginated = all_examples[offset:offset + limit]
    return [ExampleResponse(**ex) for ex in paginated]


@router.post(
    "/",
    response_model=ExampleResponse,
    status_code=status.HTTP_201_CREATED,
    summary="Create Example",
    description="Create a new example resource",
)
async def create_example(request: ExampleCreateRequest) -> ExampleResponse:
    """Create a new example resource.

    Args:
        request: Example creation request with validation

    Returns:
        ExampleResponse: Created example resource

    Raises:
        HTTPException: 422 if validation fails

    Example:
        POST /examples/
        Body: {
            "name": "New Example",
            "value": 42,
            "description": "A new example",
            "tags": ["demo"]
        }
        Response: {
            "id": "550e8400-e29b-41d4-a716-446655440000",
            "name": "New Example",
            "value": 42,
            "description": "A new example",
            "tags": ["demo"],
            "created_at": "2025-11-01T12:00:00Z",
            "updated_at": "2025-11-01T12:00:00Z"
        }
    """
    example_id = str(uuid.uuid4())
    now = datetime.now(UTC).isoformat()
    
    example = {
        "id": example_id,
        "name": request.name,
        "value": request.value,
        "description": request.description,
        "tags": request.tags or [],
        "created_at": now,
        "updated_at": now,
    }
    
    _examples_db[example_id] = example
    return ExampleResponse(**example)


@router.get(
    "/{example_id}",
    response_model=ExampleResponse,
    status_code=status.HTTP_200_OK,
    summary="Get Example",
    description="Retrieve a specific example by ID",
)
async def get_example(
    example_id: Annotated[str, Path(description="Example ID (UUID)")],
) -> ExampleResponse:
    """Get a specific example by ID.

    Args:
        example_id: UUID of the example to retrieve

    Returns:
        ExampleResponse: Example resource

    Raises:
        HTTPException: 404 if example not found

    Example:
        GET /examples/550e8400-e29b-41d4-a716-446655440000
        Response: {
            "id": "550e8400-e29b-41d4-a716-446655440000",
            "name": "Example 1",
            "value": 42,
            ...
        }
    """
    if example_id not in _examples_db:
        raise HTTPException(
            status_code=status.HTTP_404_NOT_FOUND,
            detail=f"Example {example_id} not found",
        )
    
    return ExampleResponse(**_examples_db[example_id])


@router.put(
    "/{example_id}",
    response_model=ExampleResponse,
    status_code=status.HTTP_200_OK,
    summary="Update Example",
    description="Update an existing example",
)
async def update_example(
    example_id: Annotated[str, Path(description="Example ID (UUID)")],
    request: ExampleUpdateRequest,
) -> ExampleResponse:
    """Update an existing example.

    Args:
        example_id: UUID of the example to update
        request: Update request with optional fields

    Returns:
        ExampleResponse: Updated example resource

    Raises:
        HTTPException: 404 if example not found, 422 if validation fails

    Example:
        PUT /examples/550e8400-e29b-41d4-a716-446655440000
        Body: {"name": "Updated Example"}
        Response: {
            "id": "550e8400-e29b-41d4-a716-446655440000",
            "name": "Updated Example",
            ...
        }
    """
    if example_id not in _examples_db:
        raise HTTPException(
            status_code=status.HTTP_404_NOT_FOUND,
            detail=f"Example {example_id} not found",
        )
    
    example = _examples_db[example_id]
    
    # Update only provided fields
    if request.name is not None:
        example["name"] = request.name
    if request.value is not None:
        example["value"] = request.value
    if request.description is not None:
        example["description"] = request.description
    if request.tags is not None:
        example["tags"] = request.tags
    
    example["updated_at"] = datetime.now(UTC).isoformat()
    
    _examples_db[example_id] = example
    return ExampleResponse(**example)


@router.delete(
    "/{example_id}",
    status_code=status.HTTP_204_NO_CONTENT,
    summary="Delete Example",
    description="Delete an existing example",
)
async def delete_example(
    example_id: Annotated[str, Path(description="Example ID (UUID)")],
) -> None:
    """Delete an existing example.

    Args:
        example_id: UUID of the example to delete

    Raises:
        HTTPException: 404 if example not found

    Example:
        DELETE /examples/550e8400-e29b-41d4-a716-446655440000
        Response: 204 No Content
    """
    if example_id not in _examples_db:
        raise HTTPException(
            status_code=status.HTTP_404_NOT_FOUND,
            detail=f"Example {example_id} not found",
        )
    
    del _examples_db[example_id]
{%- endif %}
