{%- if api_tracks | lower not in ["python", "python+node"] %}
"""Error handling middleware disabled - enable with api_tracks=python or python+node."""
{%- else %}
"""Global error handlers for the API.

This module provides centralized error handling for all API exceptions,
ensuring consistent error responses across the application.
"""

from __future__ import annotations

from typing import Any

from fastapi import FastAPI, HTTPException, Request, status
from fastapi.exceptions import RequestValidationError
from fastapi.responses import JSONResponse

from ..models.responses import ErrorResponse


def add_error_handlers(app: FastAPI) -> None:
    """Register global error handlers with the FastAPI application.
    
    Handles validation errors, HTTP exceptions, and unexpected errors
    with consistent error response formatting.
    
    Args:
        app: FastAPI application instance.
    
    Example:
        >>> from fastapi import FastAPI
        >>> app = FastAPI()
        >>> add_error_handlers(app)
    """

    @app.exception_handler(RequestValidationError)
    async def validation_exception_handler(
        request: Request,
        exc: RequestValidationError,
    ) -> JSONResponse:
        """Handle request validation errors.
        
        Returns detailed field-level validation errors in a consistent format.
        """
        errors: list[dict[str, Any]] = []
        for error in exc.errors():
            errors.append({
                "loc": error["loc"],
                "msg": error["msg"],
                "type": error["type"],
            })
        
        error_response = ErrorResponse(
            detail=errors,
            status_code=status.HTTP_422_UNPROCESSABLE_ENTITY,
            request_id=request.headers.get("X-Request-ID"),
        )
        
        return JSONResponse(
            status_code=status.HTTP_422_UNPROCESSABLE_ENTITY,
            content=error_response.model_dump(),
        )

    @app.exception_handler(HTTPException)
    async def http_exception_handler(
        request: Request,
        exc: HTTPException,
    ) -> JSONResponse:
        """Handle HTTP exceptions.
        
        Converts FastAPI HTTP exceptions to consistent error responses.
        """
        error_response = ErrorResponse(
            detail=exc.detail,
            status_code=exc.status_code,
            request_id=request.headers.get("X-Request-ID"),
        )
        
        return JSONResponse(
            status_code=exc.status_code,
            content=error_response.model_dump(),
        )

    @app.exception_handler(Exception)
    async def general_exception_handler(
        request: Request,
        exc: Exception,
    ) -> JSONResponse:
        """Handle unexpected exceptions.
        
        Returns a generic 500 error to avoid leaking internal details.
        The full exception is logged for debugging.
        """
        # In production, log the exception here
        # logger.error("Unhandled exception", exc_info=exc)
        
        error_response = ErrorResponse(
            detail="An unexpected error occurred",
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            request_id=request.headers.get("X-Request-ID"),
        )
        
        return JSONResponse(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            content=error_response.model_dump(),
        )
{%- endif %}
