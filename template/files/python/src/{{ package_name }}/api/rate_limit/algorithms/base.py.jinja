{%- if api_tracks | lower not in ["python", "python+node"] or not rate_limiting_enabled | default(false) %}
"""Rate limiting algorithm base disabled."""
{%- else %}
"""Abstract base class for rate limiting algorithms."""

from __future__ import annotations

from abc import ABC, abstractmethod
from dataclasses import dataclass


@dataclass
class RateLimitResult:
    """Result of a rate limit check."""

    allowed: bool
    """Whether the request is allowed (under limit)."""

    current_count: int
    """Current request count in the window."""

    limit: int
    """Maximum requests allowed in the window."""

    remaining: int
    """Requests remaining in the current window."""

    reset_at: int
    """Unix timestamp when the rate limit resets."""

    retry_after: int
    """Seconds until rate limit resets (for 429 responses)."""


class RateLimiter(ABC):
    """Abstract interface for rate limiting algorithms."""

    @abstractmethod
    async def check_limit(
        self,
        key: str,
        limit: int,
        window: int,
    ) -> RateLimitResult:
        """Check if request is within rate limit.

        Args:
            key: Rate limit key (e.g., "ratelimit:ip:192.0.2.1:/api/v1/search")
            limit: Maximum requests per window
            window: Time window in seconds

        Returns:
            RateLimitResult indicating whether request is allowed

        Raises:
            Exception: If backend operation fails
        """
        ...

    @abstractmethod
    async def get_remaining(self, key: str, limit: int) -> int:
        """Get remaining requests in current window.

        Args:
            key: Rate limit key
            limit: Maximum requests per window

        Returns:
            Number of requests remaining (0 if limit exceeded)
        """
        ...

    @abstractmethod
    async def get_reset_time(self, key: str, window: int) -> int:
        """Get Unix timestamp when rate limit resets.

        Args:
            key: Rate limit key
            window: Time window in seconds

        Returns:
            Unix timestamp of next reset
        """
        ...
{%- endif %}
