{% if saas_starter_module == "enabled" and saas_cicd == "github" %}
name: Database

on:
  push:
    branches: [main, develop]
    paths:
      {% if saas_orm == "prisma" %}
      - 'prisma/**'
      {% elif saas_orm == "drizzle" %}
      - 'db/**'
      {% endif %}
  pull_request:
    branches: [main, develop]
    paths:
      {% if saas_orm == "prisma" %}
      - 'prisma/**'
      {% elif saas_orm == "drizzle" %}
      - 'db/**'
      {% endif %}

concurrency:
  group: {% raw %}${{ github.workflow }}-${{ github.ref }}{% endraw %}
  cancel-in-progress: true

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '8'

jobs:
  # ============================================================================
  # Schema Validation
  # ============================================================================
  validate-schema:
    name: Validate Database Schema
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: {{ '${{ env.PNPM_VERSION }}' }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: {{ '${{ env.NODE_VERSION }}' }}
          cache: 'pnpm'
      
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      
      {% if saas_orm == "prisma" %}
      - name: Validate Prisma schema
        run: pnpm exec prisma validate
      
      - name: Format schema
        run: pnpm exec prisma format
      
      - name: Check for schema changes
        run: |
          if ! git diff --quiet prisma/schema.prisma; then
            echo "? Schema is not formatted. Run 'pnpm exec prisma format' locally."
            exit 1
          fi
      {% elif saas_orm == "drizzle" %}
      - name: Generate Drizzle migrations
        run: pnpm run db:generate
      
      - name: Check migration files
        run: |
          if [ -z "$(ls -A db/migrations)" ]; then
            echo "??  No migration files found"
          else
            echo "? Migration files exist"
            ls -lah db/migrations
          fi
      {% endif %}
  
  # ============================================================================
  # Migration Test
  # ============================================================================
  test-migrations:
    name: Test Database Migrations
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: {{ '${{ env.PNPM_VERSION }}' }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: {{ '${{ env.NODE_VERSION }}' }}
          cache: 'pnpm'
      
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      
      {% if saas_orm == "prisma" %}
      - name: Run migrations
        run: pnpm exec prisma migrate deploy
        env:
          DATABASE_URL: postgresql://test:test@localhost:5432/test
      
      - name: Seed database
        run: pnpm run db:seed
        env:
          DATABASE_URL: postgresql://test:test@localhost:5432/test
      
      - name: Verify database state
        run: |
          pnpm exec prisma db pull --schema=./prisma/schema.prisma
          pnpm exec prisma validate
        env:
          DATABASE_URL: postgresql://test:test@localhost:5432/test
      {% elif saas_orm == "drizzle" %}
      - name: Run migrations
        run: pnpm run db:migrate
        env:
          DATABASE_URL: postgresql://test:test@localhost:5432/test
      
      - name: Seed database
        run: pnpm run db:seed
        env:
          DATABASE_URL: postgresql://test:test@localhost:5432/test
      {% endif %}
  
  # ============================================================================
  # Migration Preview (on PR)
  # ============================================================================
  migration-preview:
    name: Migration Preview
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: github.event_name == 'pull_request'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: {{ '${{ env.PNPM_VERSION }}' }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: {{ '${{ env.NODE_VERSION }}' }}
          cache: 'pnpm'
      
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      
      {% if saas_orm == "prisma" %}
      - name: Detect schema changes
        run: |
          if git diff --name-only origin/main...HEAD | grep -q 'prisma/schema.prisma'; then
            echo "?? Prisma schema has changed"
            git diff origin/main...HEAD prisma/schema.prisma
          else
            echo "? No schema changes detected"
          fi
      {% elif saas_orm == "drizzle" %}
      - name: Detect migration changes
        run: |
          if git diff --name-only origin/main...HEAD | grep -q 'db/migrations'; then
            echo "?? New migrations detected"
            ls -lah db/migrations
          else
            echo "? No new migrations detected"
          fi
      {% endif %}
      
      - name: Comment PR with migration info
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            {% if saas_orm == "prisma" %}
            const schemaChanged = fs.existsSync('prisma/schema.prisma');
            if (schemaChanged) {
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: '?? **Database schema changes detected**\n\nPlease review the Prisma schema changes carefully and ensure migrations are properly generated before merging.'
              });
            }
            {% elif saas_orm == "drizzle" %}
            const migrationsExist = fs.existsSync('db/migrations') && fs.readdirSync('db/migrations').length > 0;
            if (migrationsExist) {
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: '?? **New database migrations detected**\n\nPlease review the migration files carefully before merging.'
              });
            }
            {% endif %}
{% endif %}
