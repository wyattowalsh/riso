{% if saas_starter_module == "enabled" and saas_orm == "prisma" %}
// Prisma Schema for {{ project_name }}
// 
// Best practices implemented:
// - CUID2 for IDs (better than UUID for database performance)
// - Proper indexes for query optimization
// - Cascade deletes with onDelete rules
// - JSON fields for flexible metadata
// - Timestamps for audit trails
// - Composite indexes for common queries
//
// Learn more: https://pris.ly/d/prisma-schema

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["fullTextSearch", "fullTextIndex", "jsonProtocol"]
  binaryTargets   = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  {% if saas_database == "neon" %}
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL") // For migrations, bypasses connection pooler
  {% elif saas_database == "supabase" %}
  provider = "postgresql"
  url      = env("DATABASE_URL")
  {% endif %}
}

// ============================================================================
// User Management
// ============================================================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  emailVerified DateTime? @map("email_verified")
  name          String?
  image         String?
  
  // Authentication
  {% if saas_auth == "authjs" %}
  accounts      Account[]
  sessions      Session[]
  {% endif %}
  
  // Multi-tenancy
  memberships   OrganizationMembership[]
  
  // SaaS entities
  subscriptions Subscription[]
  apiKeys       ApiKey[]
  auditLogs     AuditLog[]
  
  // Metadata
  metadata      Json?     @default("{}")
  
  // Timestamps
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  
  @@index([email])
  @@index([createdAt])
  @@map("users")
}

{% if saas_auth == "authjs" %}
// ============================================================================
// Auth.js Required Models
// ============================================================================

model Account {
  id                String  @id @default(cuid())
  userId            String  @map("user_id")
  type              String
  provider          String
  providerAccountId String  @map("provider_account_id")
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([provider, providerAccountId])
  @@index([userId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id")
  expires      DateTime
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime
  
  @@unique([identifier, token])
  @@map("verification_tokens")
}
{% endif %}

// ============================================================================
// Multi-Tenant Organizations
// ============================================================================

model Organization {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  logoUrl     String?  @map("logo_url")
  description String?  @db.Text
  
  // Subscription & Limits
  plan        String   @default("free") // free, starter, pro, enterprise
  maxSeats    Int      @default(5) @map("max_seats")
  currentUsage Json?   @default("{}") @map("current_usage") // Store usage metrics
  
  // Relationships
  memberships  OrganizationMembership[]
  subscription Subscription?
  apiKeys      ApiKey[]
  auditLogs    AuditLog[]
  {% if saas_enterprise_bridge == "workos" %}
  workosOrganizationId String? @unique @map("workos_organization_id")
  {% endif %}
  
  // Metadata
  settings    Json?    @default("{}")
  metadata    Json?    @default("{}")
  
  // Timestamps
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  
  @@index([slug])
  @@index([plan])
  @@index([createdAt])
  @@map("organizations")
}

model OrganizationMembership {
  id             String   @id @default(cuid())
  userId         String   @map("user_id")
  organizationId String   @map("organization_id")
  role           String   @default("member") // owner, admin, member
  
  // Invitation tracking
  invitedBy      String?  @map("invited_by")
  invitedAt      DateTime? @map("invited_at")
  acceptedAt     DateTime? @map("accepted_at")
  
  // Relationships
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  // Timestamps
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")
  
  @@unique([userId, organizationId])
  @@index([organizationId])
  @@index([userId])
  @@index([role])
  @@map("organization_memberships")
}

// ============================================================================
// Billing & Subscriptions
// ============================================================================

model Subscription {
  id          String   @id @default(cuid())
  
  // Ownership (either user or organization)
  userId         String?       @map("user_id")
  organizationId String?       @unique @map("organization_id")
  
  // Billing provider IDs
  {% if saas_billing == "stripe" %}
  stripeCustomerId      String? @unique @map("stripe_customer_id")
  stripeSubscriptionId  String? @unique @map("stripe_subscription_id")
  stripePriceId         String? @map("stripe_price_id")
  {% elif saas_billing == "paddle" %}
  paddleCustomerId      String? @unique @map("paddle_customer_id")
  paddleSubscriptionId  String? @unique @map("paddle_subscription_id")
  paddlePriceId         String? @map("paddle_price_id")
  {% endif %}
  
  // Subscription details
  status              String   @default("incomplete") // incomplete, trialing, active, past_due, canceled, unpaid
  plan                String   // starter, pro, enterprise
  billingCycle        String   @default("monthly") @map("billing_cycle") // monthly, annual
  
  // Pricing
  amount              Int?     // In cents
  currency            String   @default("usd")
  
  // Period tracking
  currentPeriodStart  DateTime? @map("current_period_start")
  currentPeriodEnd    DateTime? @map("current_period_end")
  trialStart          DateTime? @map("trial_start")
  trialEnd            DateTime? @map("trial_end")
  cancelAtPeriodEnd   Boolean  @default(false) @map("cancel_at_period_end")
  canceledAt          DateTime? @map("canceled_at")
  
  // Relationships
  user         User?         @relation(fields: [userId], references: [id], onDelete: SetNull)
  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  usageRecords UsageRecord[]
  invoices     Invoice[]
  
  // Metadata
  metadata     Json?    @default("{}")
  
  // Timestamps
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")
  
  @@index([status])
  @@index([plan])
  @@index([currentPeriodEnd])
  @@index([userId])
  @@index([organizationId])
  @@map("subscriptions")
}

model UsageRecord {
  id             String   @id @default(cuid())
  subscriptionId String   @map("subscription_id")
  
  // Usage details
  metricName     String   @map("metric_name") // api_calls, ai_tokens, storage_gb, etc.
  quantity       Int
  unit           String   @default("unit")
  
  // Period
  periodStart    DateTime @map("period_start")
  periodEnd      DateTime @map("period_end")
  
  // Billing sync
  reportedToProvider Boolean @default(false) @map("reported_to_provider")
  reportedAt         DateTime? @map("reported_at")
  
  // Relationship
  subscription   Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  
  // Metadata
  metadata       Json?    @default("{}")
  
  // Timestamps
  createdAt      DateTime @default(now()) @map("created_at")
  
  @@index([subscriptionId, periodStart])
  @@index([metricName])
  @@index([reportedToProvider])
  @@map("usage_records")
}

model Invoice {
  id             String   @id @default(cuid())
  subscriptionId String   @map("subscription_id")
  
  // Billing provider IDs
  {% if saas_billing == "stripe" %}
  stripeInvoiceId String? @unique @map("stripe_invoice_id")
  {% elif saas_billing == "paddle" %}
  paddleInvoiceId String? @unique @map("paddle_invoice_id")
  {% endif %}
  
  // Invoice details
  status         String   // draft, open, paid, void, uncollectible
  amountDue      Int      @map("amount_due") // In cents
  amountPaid     Int      @default(0) @map("amount_paid")
  currency       String   @default("usd")
  
  // URLs
  hostedInvoiceUrl String? @map("hosted_invoice_url")
  invoicePdfUrl    String? @map("invoice_pdf_url")
  
  // Dates
  dueDate        DateTime? @map("due_date")
  paidAt         DateTime? @map("paid_at")
  voidedAt       DateTime? @map("voided_at")
  
  // Relationship
  subscription   Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  
  // Metadata
  metadata       Json?    @default("{}")
  
  // Timestamps
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")
  
  @@index([subscriptionId])
  @@index([status])
  @@index([dueDate])
  @@map("invoices")
}

// ============================================================================
// API Access & Security
// ============================================================================

model ApiKey {
  id             String   @id @default(cuid())
  
  // Ownership
  userId         String?  @map("user_id")
  organizationId String?  @map("organization_id")
  
  // Key details
  name           String
  keyHash        String   @unique @map("key_hash") // bcrypt/argon2 hash, never store plain key
  keyPrefix      String   @map("key_prefix") // First 8 chars for identification
  
  // Permissions
  scopes         String[] @default([]) // read, write, admin, etc.
  
  // Usage tracking
  lastUsedAt     DateTime? @map("last_used_at")
  usageCount     Int      @default(0) @map("usage_count")
  
  // Expiration & Revocation
  expiresAt      DateTime? @map("expires_at")
  revokedAt      DateTime? @map("revoked_at")
  revokedReason  String?  @map("revoked_reason")
  
  // Relationships
  user         User?         @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  // Metadata
  metadata     Json?    @default("{}")
  
  // Timestamps
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")
  
  @@index([keyPrefix])
  @@index([userId])
  @@index([organizationId])
  @@index([revokedAt])
  @@map("api_keys")
}

// ============================================================================
// Audit Logging & Compliance
// ============================================================================

model AuditLog {
  id             String   @id @default(cuid())
  
  // Actor (who performed the action)
  userId         String?  @map("user_id")
  organizationId String?  @map("organization_id")
  
  // Action details
  action         String   // user.login, subscription.created, api_key.revoked, etc.
  resourceType   String   @map("resource_type") // user, subscription, organization, etc.
  resourceId     String?  @map("resource_id")
  
  // Request context
  ipAddress      String?  @map("ip_address")
  userAgent      String?  @map("user_agent") @db.Text
  
  // Tracing
  correlationId  String?  @map("correlation_id")
  
  // Additional context
  metadata       Json?    @default("{}")
  
  // Relationships
  user         User?         @relation(fields: [userId], references: [id], onDelete: SetNull)
  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  // Timestamp (immutable)
  timestamp    DateTime @default(now())
  
  @@index([userId])
  @@index([organizationId])
  @@index([action])
  @@index([correlationId])
  @@index([timestamp])
  @@map("audit_logs")
}

// ============================================================================
// Feature Flags (Optional)
// ============================================================================

model FeatureFlag {
  id          String   @id @default(cuid())
  key         String   @unique
  name        String
  description String?  @db.Text
  enabled     Boolean  @default(false)
  
  // Targeting
  rolloutPercentage Int @default(0) @map("rollout_percentage") // 0-100
  allowedPlans      String[] @default([]) @map("allowed_plans") // Plans that can access
  allowedOrgs       String[] @default([]) @map("allowed_orgs") // Specific org IDs
  
  // Metadata
  metadata    Json?    @default("{}")
  
  // Timestamps
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  
  @@index([key])
  @@index([enabled])
  @@map("feature_flags")
}
{% endif %}
