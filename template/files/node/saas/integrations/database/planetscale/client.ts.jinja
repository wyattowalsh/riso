{% if saas_database == 'planetscale' %}
/**
 * PlanetScale Database Client
 * 
 * MySQL-compatible serverless database with vitess architecture.
 * Features: Database branching, non-blocking schema changes, horizontal sharding.
 * 
 * Use when: Need MySQL compatibility, horizontal scaling critical, 
 * team comfortable with vitess workflows.
 * 
 * Environment variables:
 * - DATABASE_URL: PlanetScale connection string
 * - DATABASE_HOST (optional): Override host
 * - DATABASE_USERNAME (optional): Override username
 * - DATABASE_PASSWORD (optional): Override password
 */

import { connect } from '@planetscale/database';
import type { Connection } from '@planetscale/database';

// Validate environment variables
const DATABASE_URL = process.env.DATABASE_URL;

if (!DATABASE_URL) {
  throw new Error(
    'DATABASE_URL is required for PlanetScale. ' +
    'Get your connection string from https://planetscale.com'
  );
}

/**
 * PlanetScale connection configuration
 */
export const db: Connection = connect({
  url: DATABASE_URL,
  // Optional: Override with individual credentials
  host: process.env.DATABASE_HOST,
  username: process.env.DATABASE_USERNAME,
  password: process.env.DATABASE_PASSWORD,
});

/**
 * Execute a query with type safety
 * 
 * @example
 * const users = await query<User>('SELECT * FROM users WHERE id = ?', [userId]);
 */
export async function query<T = any>(
  sql: string,
  params: any[] = []
): Promise<T[]> {
  try {
    const results = await db.execute(sql, params);
    return results.rows as T[];
  } catch (error) {
    console.error('PlanetScale query error:', error);
    throw error;
  }
}

/**
 * Execute a query and return the first result
 * 
 * @example
 * const user = await queryOne<User>('SELECT * FROM users WHERE id = ?', [userId]);
 */
export async function queryOne<T = any>(
  sql: string,
  params: any[] = []
): Promise<T | null> {
  const results = await query<T>(sql, params);
  return results[0] || null;
}

/**
 * Execute a write operation (INSERT, UPDATE, DELETE)
 * 
 * @example
 * const result = await execute('INSERT INTO users (name, email) VALUES (?, ?)', ['John', 'john@example.com']);
 */
export async function execute(
  sql: string,
  params: any[] = []
): Promise<{ insertId: string; rowsAffected: number }> {
  try {
    const result = await db.execute(sql, params);
    return {
      insertId: result.insertId,
      rowsAffected: result.rowsAffected,
    };
  } catch (error) {
    console.error('PlanetScale execute error:', error);
    throw error;
  }
}

/**
 * Transaction helper (PlanetScale supports transactions)
 * 
 * @example
 * await transaction(async (tx) => {
 *   await tx.execute('INSERT INTO users ...');
 *   await tx.execute('INSERT INTO profiles ...');
 * });
 */
export async function transaction<T>(
  callback: (tx: Connection) => Promise<T>
): Promise<T> {
  // Note: PlanetScale serverless doesn't support traditional transactions
  // Use application-level compensation logic or idempotency keys
  return callback(db);
}

/**
 * Health check for PlanetScale connection
 */
export async function healthCheck(): Promise<boolean> {
  try {
    await db.execute('SELECT 1');
    return true;
  } catch (error) {
    console.error('PlanetScale health check failed:', error);
    return false;
  }
}

// Export the connection for advanced usage
export { db as planetscale };

{% endif %}
