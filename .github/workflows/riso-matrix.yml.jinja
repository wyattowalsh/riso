{% if ci_platform == 'github-actions' -%}
# Matrix Testing Workflow
# Auto-generated by Riso template • DO NOT EDIT MANUALLY
# Runs quality checks across Python {{ python_versions|join(', ') }} in parallel
# All versions must pass for PR merge to proceed

name: Matrix Testing

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

env:
  QUALITY_PROFILE: {{ quality_profile }}
  PACKAGE_NAME: {{ package_name }}

jobs:
  matrix-test:
    name: Python {% raw %}${{ matrix.python-version }}{% endraw %} Quality
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    strategy:
      # Never fail-fast - we want to see all Python version results
      fail-fast: false
      max-parallel: 3
      matrix:
        python-version: {{ python_versions|tojson }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python {% raw %}${{ matrix.python-version }}{% endraw %}
        uses: actions/setup-python@v5
        with:
          python-version: {% raw %}${{ matrix.python-version }}{% endraw %}
      
      - name: Cache dependencies (version-specific)
        uses: actions/cache@v4
        id: cache-matrix
        with:
          path: |
            ~/.cache/uv
            ~/.cache/pip
          key: {% raw %}${{ runner.os }}-py${{ matrix.python-version }}-${{ hashFiles('**/uv.lock') }}{% endraw %}
          restore-keys: |
            {% raw %}${{ runner.os }}-py${{ matrix.python-version }}-{% endraw %}
            {% raw %}${{ runner.os }}-{% endraw %}
      
      - name: Cache status
        run: |
          if [ "{% raw %}${{ steps.cache-matrix.outputs.cache-hit }}{% endraw %}" == "true" ]; then
            echo "✅ Cache hit for Python {% raw %}${{ matrix.python-version }}{% endraw %}"
          else
            echo "❌ Cache miss for Python {% raw %}${{ matrix.python-version }}{% endraw %}"
          fi
      
      - name: Install uv package manager
        run: curl -LsSf https://astral.sh/uv/install.sh | sh
      
      - name: Install dependencies with uv
        run: |
          export PATH="$HOME/.cargo/bin:$PATH"
          uv sync
      
      - name: Run pytest with retry logic
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 12
          max_attempts: 3
          retry_wait_seconds: 30
          exponential_backoff: true
          command: |
            export PATH="$HOME/.cargo/bin:$PATH"
            uv run pytest --tb=short --junit-xml=test-results.xml --cov --cov-report=xml
      
      - name: Run type checking (mypy)
        run: |
          export PATH="$HOME/.cargo/bin:$PATH"
          uv run mypy .
      
      - name: Run linting (ruff)
        run: |
          export PATH="$HOME/.cargo/bin:$PATH"
          uv run ruff check .
{% if quality_profile == 'strict' %}
      
      - name: Run static analysis (pylint) - strict profile only
        run: |
          export PATH="$HOME/.cargo/bin:$PATH"
          uv run pylint src/
{% endif %}
      
      - name: Upload test results and coverage
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: matrix-results-py{% raw %}${{ matrix.python-version }}{% endraw %}-{% raw %}${{ github.run_id }}{% endraw %}
          path: |
            test-results.xml
            coverage.xml
            .coverage
          retention-days: 90
      
      - name: Report matrix job status
        if: failure()
        run: |
          echo "::error::Python {% raw %}${{ matrix.python-version }}{% endraw %} quality checks failed"
          echo "This failure blocks PR merge per matrix policy"
          echo "Check logs above for specific test/lint/type failures"

  matrix-summary:
    name: Matrix Summary
    needs: matrix-test
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Check matrix results
        run: |
          if [ "{% raw %}${{ needs.matrix-test.result }}{% endraw %}" != "success" ]; then
            echo "::error::Matrix testing failed - not all Python versions passed"
            echo "All Python versions ({{ python_versions|join(', ') }}) must pass for merge"
            echo ""
            echo "Required checks:"
{%- for version in python_versions %}
            echo "  • Python {{ version }} Quality"
{%- endfor %}
            echo ""
            echo "Download version-specific artifacts to debug failures locally"
            exit 1
          fi
          echo "✅ All Python versions passed quality checks"
          echo "Tested versions: {{ python_versions|join(', ') }}"
{% endif -%}
